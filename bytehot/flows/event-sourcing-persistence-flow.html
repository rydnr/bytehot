<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>flows/event-sourcing-persistence-flow - ByteHot Documentation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3a 100%);
            color: #00ff00;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .matrix-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            opacity: 0.05;
        }

        .nav-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(15, 15, 35, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            z-index: 1000;
            border-bottom: 2px solid #00ff00;
        }

        .nav-links {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .nav-link {
            color: #00ff00;
            text-decoration: none;
            padding: 0.4rem 0.8rem;
            border: 1px solid #00ff00;
            border-radius: 4px;
            transition: all 0.3s ease;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .nav-link:hover {
            background: #00ff00;
            color: #0f0f23;
            box-shadow: 0 0 15px #00ff00;
            transform: translateY(-2px);
        }

        .content {
            margin-top: 100px;
            padding: 2rem;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        .doc-container {
            background: rgba(26, 26, 58, 0.8);
            border: 1px solid #00ff00;
            border-radius: 12px;
            padding: 3rem;
            margin: 2rem 0;
        }

        .doc-container h1 {
            color: #00cccc;
            font-size: 2.5rem;
            margin: 0 0 2rem 0;
            text-shadow: 0 0 15px #00cccc;
            text-align: center;
        }

        .doc-container h2 {
            color: #00ff00;
            font-size: 1.8rem;
            margin: 2rem 0 1rem 0;
            border-left: 4px solid #00ff00;
            padding-left: 1rem;
            text-shadow: 0 0 10px #00ff00;
        }

        .doc-container h3 {
            color: #00cccc;
            font-size: 1.4rem;
            margin: 1.5rem 0 1rem 0;
        }

        .doc-container h4, .doc-container h5, .doc-container h6 {
            color: #ffffff;
            margin: 1rem 0 0.5rem 0;
        }

        .doc-container p {
            color: #ffffff;
            margin: 1rem 0;
            line-height: 1.8;
        }

        .doc-container ul, .doc-container ol {
            color: #ffffff;
            margin: 1rem 0;
            padding-left: 2rem;
        }

        .doc-container li {
            margin: 0.5rem 0;
            line-height: 1.6;
        }

        .doc-container code {
            background: rgba(0, 0, 0, 0.5);
            color: #00ff00;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            border: 1px solid rgba(0, 255, 0, 0.3);
        }

        .doc-container pre {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #00ff00;
            border-radius: 8px;
            padding: 1.5rem;
            overflow-x: auto;
            margin: 1.5rem 0;
        }

        .doc-container pre code {
            background: none;
            padding: 0;
            border: none;
        }

        .doc-container a {
            color: #00cccc;
            text-decoration: none;
            border-bottom: 1px dotted #00cccc;
            transition: all 0.3s ease;
        }

        .doc-container a:hover {
            color: #ffffff;
            border-bottom-color: #ffffff;
            text-shadow: 0 0 5px #00cccc;
        }

        .doc-container table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            background: rgba(0, 0, 0, 0.3);
        }

        .doc-container th, .doc-container td {
            border: 1px solid #00ff00;
            padding: 0.8rem;
            text-align: left;
        }

        .doc-container th {
            background: rgba(0, 255, 0, 0.1);
            color: #00ff00;
            font-weight: bold;
        }

        .doc-container td {
            color: #ffffff;
        }

        .doc-container blockquote {
            border-left: 4px solid #00cccc;
            padding-left: 1.5rem;
            margin: 1.5rem 0;
            color: #00cccc;
            font-style: italic;
            background: rgba(0, 204, 204, 0.05);
            padding: 1rem 1rem 1rem 1.5rem;
            border-radius: 0 8px 8px 0;
        }

        .footer {
            background: rgba(0, 0, 0, 0.8);
            padding: 2rem;
            text-align: center;
            border-top: 2px solid #00ff00;
            margin-top: 4rem;
        }

        .footer a {
            color: #00ff00;
            text-decoration: none;
        }

        .footer a:hover {
            text-shadow: 0 0 10px #00ff00;
        }

        @media (max-width: 768px) {
            .nav-links {
                gap: 0.8rem;
            }
            
            .nav-link {
                padding: 0.3rem 0.6rem;
                font-size: 0.8rem;
            }
            
            .content {
                padding: 1rem;
            }
            
            .doc-container {
                padding: 2rem;
            }
            
            .doc-container h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="matrix-bg"></div>
    
    <nav class="nav-header">
        <div class="nav-links">
            <a href="../index.html" class="nav-link">Home</a>
            <a href="../story.html" class="nav-link">üìñ Story</a>
            <a href="../GETTING_STARTED.html" class="nav-link">üöÄ Getting Started</a>
            <a href="../implementation.html" class="nav-link">‚öôÔ∏è Implementation</a>
            <a href="../journal.html" class="nav-link">üìî Journal</a>
            <a href="../javadocs/" class="nav-link">JavaDocs</a>
            <a href="https://github.com/rydnr/bytehot" class="nav-link">GitHub</a>
        </div>
    </nav>

    <div class="content">
        <div class="doc-container">
    <div class="content">
        <div class="doc-container">
<h1
id="overview-building-complete-system-memory-and-intelligence">Overview:
Building Complete System Memory and Intelligence</h1>
<p>The Event Sourcing Persistence Flow represents ByteHot's
sophisticated approach to maintaining complete system memory through
comprehensive event capture, intelligent storage, and powerful replay
capabilities. This flow demonstrates how every significant action in
ByteHot is captured as an immutable event, stored with rich metadata,
and made available for analysis, debugging, and system intelligence.
Unlike simple logging, this flow shows how ByteHot builds a complete
understanding of system behavior over time through persistent event
streams.</p>
<h2 id="flow-participants-and-their-roles">Flow Participants and Their
Roles</h2>
<ul>
<li><strong><strong>EventStorePort</strong></strong>: Secondary port for
event persistence operations (Domain)</li>
<li><strong><strong>FilesystemEventStoreAdapter</strong></strong>:
File-based event storage implementation (Infrastructure)</li>
<li><strong><strong>EventSerializationSupport</strong></strong>: JSON
serialization for event persistence (Infrastructure)</li>
<li><strong><strong>EventSnapshotGenerator</strong></strong>: System
state snapshot creation (Domain)</li>
<li><strong><strong>CausalChainTracker</strong></strong>: Event
causality analysis and tracking (Domain)</li>
<li><strong><strong>EventReplayEngine</strong></strong>: Historical
event reconstruction and replay (Domain)</li>
<li><strong><strong>StatePreserver</strong></strong>: Critical state
preservation during events (Domain)</li>
<li><strong><strong>JsonClassFileChanged</strong></strong>: Event DTO
for serialization (Infrastructure)</li>
</ul>
<h2 id="what-this-flow-demonstrates">What This Flow Demonstrates</h2>
<ul>
<li><strong><strong>Complete event capture</strong></strong> for
comprehensive system audit trails</li>
<li><strong><strong>Intelligent event storage</strong></strong> with
hierarchical organization and versioning</li>
<li><strong><strong>Rich metadata preservation</strong></strong>
enabling sophisticated analysis and debugging</li>
<li><strong><strong>Causal chain tracking</strong></strong> for
understanding event relationships over time</li>
<li><strong><strong>Snapshot generation and replay</strong></strong> for
system state reconstruction</li>
</ul>
<h2 id="the-event-persistence-pipeline">The Event Persistence
Pipeline</h2>
<pre><code>Event Generation ‚Üí Metadata Enrichment ‚Üí Serialization ‚Üí Storage ‚Üí Indexing ‚Üí Analysis
       ‚Üì                  ‚Üì               ‚Üì           ‚Üì         ‚Üì         ‚Üì
  Domain Events      Event Context      JSON Format  File System  Causal Chains  Intelligence
</code></pre>
<h1 id="phase-1-event-capture-and-metadata-enrichment">Phase 1: Event
Capture and Metadata Enrichment</h1>
<p>The flow begins when domain events are generated throughout ByteHot
operations, requiring capture and enrichment before persistence.</p>
<h2 id="step-1.1-domain-event-interception-and-processing">Step 1.1:
Domain Event Interception and Processing</h2>
<div class="sourceCode" id="cb2"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">// From: EventCaptureInterceptor.java (Application Layer)</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> EventCaptureInterceptor <span class="op">{</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">interceptDomainEvent</span><span class="op">(</span><span class="dt">final</span> VersionedDomainEvent event<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Enrich event with system metadata</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>            <span class="dt">final</span> EnrichedEvent enrichedEvent <span class="op">=</span> <span class="fu">enrichEventWithMetadata</span><span class="op">(</span>event<span class="op">);</span>  <span class="co">// ‚Üí Step 1.2</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Capture system state snapshot if critical event</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span><span class="fu">isCriticalEvent</span><span class="op">(</span>event<span class="op">))</span> <span class="op">{</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>                <span class="fu">captureSystemStateSnapshot</span><span class="op">(</span>enrichedEvent<span class="op">);</span>  <span class="co">// ‚Üí Step 1.3</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Analyze causal relationships</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>            <span class="fu">analyzeCausalRelationships</span><span class="op">(</span>enrichedEvent<span class="op">);</span>  <span class="co">// ‚Üí Step 1.4</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Route to persistence pipeline</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>            <span class="fu">routeToPersistence</span><span class="op">(</span>enrichedEvent<span class="op">);</span>  <span class="co">// ‚Üí Phase 2</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="dt">final</span> <span class="bu">Exception</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>            <span class="fu">handleEventCaptureFailure</span><span class="op">(</span>event<span class="op">,</span> e<span class="op">);</span>  <span class="co">// ‚Üí Step 1.5</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">boolean</span> <span class="fu">isCriticalEvent</span><span class="op">(</span><span class="dt">final</span> VersionedDomainEvent event<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> event <span class="kw">instanceof</span> ClassFileChanged </span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>            <span class="op">||</span> event <span class="kw">instanceof</span> BytecodeValidated</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>            <span class="op">||</span> event <span class="kw">instanceof</span> ClassRedefinitionSucceeded</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>            <span class="op">||</span> event <span class="kw">instanceof</span> ClassRedefinitionFailed</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>            <span class="op">||</span> event <span class="kw">instanceof</span> HotSwapRequested</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>            <span class="op">||</span> event <span class="kw">instanceof</span> ByteHotAgentAttached</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>            <span class="op">||</span> event <span class="kw">instanceof</span> UserSessionStarted<span class="op">;</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong><strong>Runtime Behavior</strong></strong>: Event capture
intercepts all domain events as they flow through the system, providing
a centralized point for enrichment and routing to persistence
infrastructure.</p>
<h2 id="step-1.2-event-metadata-enrichment">Step 1.2: Event Metadata
Enrichment</h2>
<div class="sourceCode" id="cb3"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">// From: EventMetadataEnricher.java (Domain Service)</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> EventMetadataEnricher <span class="op">{</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> EnrichedEvent <span class="fu">enrichEventWithMetadata</span><span class="op">(</span><span class="dt">final</span> VersionedDomainEvent event<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> EventMetadata metadata <span class="op">=</span> <span class="kw">new</span> <span class="fu">EventMetadata</span><span class="op">();</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Core identification metadata</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>        metadata<span class="op">.</span><span class="fu">setEventId</span><span class="op">(</span><span class="fu">generateEventId</span><span class="op">());</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>        metadata<span class="op">.</span><span class="fu">setEventType</span><span class="op">(</span>event<span class="op">.</span><span class="fu">getClass</span><span class="op">().</span><span class="fu">getSimpleName</span><span class="op">());</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>        metadata<span class="op">.</span><span class="fu">setCaptureTimestamp</span><span class="op">(</span>Instant<span class="op">.</span><span class="fu">now</span><span class="op">());</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>        metadata<span class="op">.</span><span class="fu">setSourceLocation</span><span class="op">(</span><span class="fu">captureSourceLocation</span><span class="op">());</span>  <span class="co">// ‚Üí Step 1.2a</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">// System context metadata</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>        metadata<span class="op">.</span><span class="fu">setSystemContext</span><span class="op">(</span><span class="fu">captureSystemContext</span><span class="op">());</span>  <span class="co">// ‚Üí Step 1.2b</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>        metadata<span class="op">.</span><span class="fu">setUserContext</span><span class="op">(</span><span class="fu">captureUserContext</span><span class="op">());</span>  <span class="co">// ‚Üí Step 1.2c</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>        metadata<span class="op">.</span><span class="fu">setEnvironmentContext</span><span class="op">(</span><span class="fu">captureEnvironmentContext</span><span class="op">());</span>  <span class="co">// ‚Üí Step 1.2d</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Performance metadata</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>        metadata<span class="op">.</span><span class="fu">setPerformanceMetrics</span><span class="op">(</span><span class="fu">capturePerformanceMetrics</span><span class="op">());</span>  <span class="co">// ‚Üí Step 1.2e</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Causal metadata</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>        metadata<span class="op">.</span><span class="fu">setCausalContext</span><span class="op">(</span><span class="fu">captureCausalContext</span><span class="op">(</span>event<span class="op">));</span>  <span class="co">// ‚Üí Step 1.2f</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">EnrichedEvent</span><span class="op">(</span>event<span class="op">,</span> metadata<span class="op">);</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> SourceLocation <span class="fu">captureSourceLocation</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Capture call stack information for event tracing</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> <span class="bu">StackTraceElement</span><span class="op">[]</span> stackTrace <span class="op">=</span> <span class="bu">Thread</span><span class="op">.</span><span class="fu">currentThread</span><span class="op">().</span><span class="fu">getStackTrace</span><span class="op">();</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Find the first non-framework stack frame</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">final</span> <span class="bu">StackTraceElement</span> frame <span class="op">:</span> stackTrace<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(!</span><span class="fu">isFrameworkClass</span><span class="op">(</span>frame<span class="op">.</span><span class="fu">getClassName</span><span class="op">()))</span> <span class="op">{</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="kw">new</span> <span class="fu">SourceLocation</span><span class="op">(</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>                    frame<span class="op">.</span><span class="fu">getClassName</span><span class="op">(),</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>                    frame<span class="op">.</span><span class="fu">getMethodName</span><span class="op">(),</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>                    frame<span class="op">.</span><span class="fu">getFileName</span><span class="op">(),</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>                    frame<span class="op">.</span><span class="fu">getLineNumber</span><span class="op">()</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>                <span class="op">);</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> SourceLocation<span class="op">.</span><span class="fu">unknown</span><span class="op">();</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> SystemContext <span class="fu">captureSystemContext</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">SystemContext</span><span class="op">(</span></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">currentTimeMillis</span><span class="op">(),</span></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Runtime</span><span class="op">.</span><span class="fu">getRuntime</span><span class="op">().</span><span class="fu">totalMemory</span><span class="op">(),</span></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Runtime</span><span class="op">.</span><span class="fu">getRuntime</span><span class="op">().</span><span class="fu">freeMemory</span><span class="op">(),</span></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Runtime</span><span class="op">.</span><span class="fu">getRuntime</span><span class="op">().</span><span class="fu">availableProcessors</span><span class="op">(),</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Thread</span><span class="op">.</span><span class="fu">activeCount</span><span class="op">(),</span></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>            <span class="fu">getCurrentGCMetrics</span><span class="op">(),</span></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>            <span class="fu">getCurrentJVMFlags</span><span class="op">()</span></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> UserContext <span class="fu">captureUserContext</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> UserSession currentSession <span class="op">=</span> UserSessionProvider<span class="op">.</span><span class="fu">getCurrentSession</span><span class="op">();</span></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>currentSession <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">new</span> <span class="fu">UserContext</span><span class="op">(</span></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>                currentSession<span class="op">.</span><span class="fu">getUser</span><span class="op">().</span><span class="fu">getId</span><span class="op">(),</span></span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>                currentSession<span class="op">.</span><span class="fu">getSessionId</span><span class="op">(),</span></span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>                currentSession<span class="op">.</span><span class="fu">getStartTime</span><span class="op">(),</span></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>                currentSession<span class="op">.</span><span class="fu">getActivityMetrics</span><span class="op">(),</span></span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>                currentSession<span class="op">.</span><span class="fu">getPreferences</span><span class="op">()</span></span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>            <span class="op">);</span></span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> UserContext<span class="op">.</span><span class="fu">anonymous</span><span class="op">();</span></span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> CausalContext <span class="fu">captureCausalContext</span><span class="op">(</span><span class="dt">final</span> VersionedDomainEvent event<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Analyze event for causal relationships</span></span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> <span class="bu">List</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> causingEventIds <span class="op">=</span> <span class="fu">findCausingEvents</span><span class="op">(</span>event<span class="op">);</span></span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> <span class="bu">String</span> rootCauseEventId <span class="op">=</span> <span class="fu">findRootCauseEvent</span><span class="op">(</span>event<span class="op">);</span></span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> <span class="dt">int</span> causalDepth <span class="op">=</span> <span class="fu">calculateCausalDepth</span><span class="op">(</span>event<span class="op">);</span></span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">CausalContext</span><span class="op">(</span></span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>            causingEventIds<span class="op">,</span></span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>            rootCauseEventId<span class="op">,</span></span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>            causalDepth<span class="op">,</span></span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>            <span class="fu">estimateEventInfluence</span><span class="op">(</span>event<span class="op">)</span></span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong><strong>Runtime Behavior</strong></strong>: Metadata
enrichment captures comprehensive context about each event, enabling
sophisticated analysis and debugging capabilities that go far beyond
simple event logging.</p>
<h2 id="step-1.3-critical-event-system-state-capture">Step 1.3: Critical
Event System State Capture</h2>
<div class="sourceCode" id="cb4"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">// From: SystemStateCapture.java (Domain Service)</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> SystemStateCapture <span class="op">{</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> SystemStateSnapshot <span class="fu">captureSystemStateSnapshot</span><span class="op">(</span><span class="dt">final</span> EnrichedEvent event<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> SystemStateSnapshotBuilder builder <span class="op">=</span> <span class="kw">new</span> <span class="fu">SystemStateSnapshotBuilder</span><span class="op">(</span>event<span class="op">);</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Capture JVM state</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>        builder<span class="op">.</span><span class="fu">addJVMState</span><span class="op">(</span><span class="fu">captureJVMState</span><span class="op">());</span>  <span class="co">// ‚Üí Step 1.3a</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Capture ByteHot internal state</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        builder<span class="op">.</span><span class="fu">addByteHotState</span><span class="op">(</span><span class="fu">captureByteHotState</span><span class="op">());</span>  <span class="co">// ‚Üí Step 1.3b</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Capture file system state</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>        builder<span class="op">.</span><span class="fu">addFileSystemState</span><span class="op">(</span><span class="fu">captureFileSystemState</span><span class="op">());</span>  <span class="co">// ‚Üí Step 1.3c</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Capture loaded classes state</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>        builder<span class="op">.</span><span class="fu">addLoadedClassesState</span><span class="op">(</span><span class="fu">captureLoadedClassesState</span><span class="op">());</span>  <span class="co">// ‚Üí Step 1.3d</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Capture event stream state</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>        builder<span class="op">.</span><span class="fu">addEventStreamState</span><span class="op">(</span><span class="fu">captureEventStreamState</span><span class="op">());</span>  <span class="co">// ‚Üí Step 1.3e</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> SystemStateSnapshot snapshot <span class="op">=</span> builder<span class="op">.</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Store snapshot for later analysis</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>        <span class="fu">storeSystemStateSnapshot</span><span class="op">(</span>snapshot<span class="op">);</span>  <span class="co">// ‚Üí Step 1.3f</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> snapshot<span class="op">;</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> JVMState <span class="fu">captureJVMState</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> <span class="bu">MemoryMXBean</span> memoryBean <span class="op">=</span> <span class="bu">ManagementFactory</span><span class="op">.</span><span class="fu">getMemoryMXBean</span><span class="op">();</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> <span class="bu">List</span><span class="op">&lt;</span><span class="bu">GarbageCollectorMXBean</span><span class="op">&gt;</span> gcBeans <span class="op">=</span> <span class="bu">ManagementFactory</span><span class="op">.</span><span class="fu">getGarbageCollectorMXBeans</span><span class="op">();</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> <span class="bu">ThreadMXBean</span> threadBean <span class="op">=</span> <span class="bu">ManagementFactory</span><span class="op">.</span><span class="fu">getThreadMXBean</span><span class="op">();</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">JVMState</span><span class="op">(</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>            memoryBean<span class="op">.</span><span class="fu">getHeapMemoryUsage</span><span class="op">(),</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>            memoryBean<span class="op">.</span><span class="fu">getNonHeapMemoryUsage</span><span class="op">(),</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>            gcBeans<span class="op">.</span><span class="fu">stream</span><span class="op">().</span><span class="fu">collect</span><span class="op">(</span>Collectors<span class="op">.</span><span class="fu">toMap</span><span class="op">(</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>                <span class="bu">GarbageCollectorMXBean</span><span class="op">::</span>getName<span class="op">,</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>                bean <span class="op">-&gt;</span> <span class="kw">new</span> <span class="fu">GCMetrics</span><span class="op">(</span>bean<span class="op">.</span><span class="fu">getCollectionCount</span><span class="op">(),</span> bean<span class="op">.</span><span class="fu">getCollectionTime</span><span class="op">())</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>            <span class="op">)),</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>            threadBean<span class="op">.</span><span class="fu">getThreadCount</span><span class="op">(),</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>            threadBean<span class="op">.</span><span class="fu">getDaemonThreadCount</span><span class="op">(),</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>            threadBean<span class="op">.</span><span class="fu">getPeakThreadCount</span><span class="op">(),</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>            <span class="fu">getCurrentClassLoadingMetrics</span><span class="op">()</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> ByteHotState <span class="fu">captureByteHotState</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> ByteHotApplication application <span class="op">=</span> ByteHotApplication<span class="op">.</span><span class="fu">getInstance</span><span class="op">();</span></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">ByteHotState</span><span class="op">(</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>            application<span class="op">.</span><span class="fu">getActiveMonitoringSessions</span><span class="op">().</span><span class="fu">size</span><span class="op">(),</span></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>            application<span class="op">.</span><span class="fu">getEventProcessingMetrics</span><span class="op">(),</span></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>            application<span class="op">.</span><span class="fu">getHotSwapMetrics</span><span class="op">(),</span></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>            application<span class="op">.</span><span class="fu">getCurrentConfiguration</span><span class="op">(),</span></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>            application<span class="op">.</span><span class="fu">getActiveUserSessions</span><span class="op">(),</span></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>            application<span class="op">.</span><span class="fu">getSystemHealthMetrics</span><span class="op">()</span></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> FileSystemState <span class="fu">captureFileSystemState</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> Path watchPath <span class="op">=</span> <span class="fu">getCurrentWatchPath</span><span class="op">();</span></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>            <span class="dt">final</span> <span class="bu">List</span><span class="op">&lt;</span>FileInfo<span class="op">&gt;</span> monitoredFiles <span class="op">=</span> Files<span class="op">.</span><span class="fu">walk</span><span class="op">(</span>watchPath<span class="op">)</span></span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">filter</span><span class="op">(</span>Files<span class="op">::</span>isRegularFile<span class="op">)</span></span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">filter</span><span class="op">(</span>path <span class="op">-&gt;</span> path<span class="op">.</span><span class="fu">toString</span><span class="op">().</span><span class="fu">endsWith</span><span class="op">(</span><span class="st">&quot;.class&quot;</span><span class="op">))</span></span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">map</span><span class="op">(</span><span class="kw">this</span><span class="op">::</span>createFileInfo<span class="op">)</span></span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">collect</span><span class="op">(</span>Collectors<span class="op">.</span><span class="fu">toList</span><span class="op">());</span></span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">new</span> <span class="fu">FileSystemState</span><span class="op">(</span></span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>                watchPath<span class="op">,</span></span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>                monitoredFiles<span class="op">,</span></span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>                <span class="fu">calculateDirectoryChecksum</span><span class="op">(</span>watchPath<span class="op">),</span></span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>                Instant<span class="op">.</span><span class="fu">now</span><span class="op">()</span></span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>            <span class="op">);</span></span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="dt">final</span> <span class="bu">IOException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> FileSystemState<span class="op">.</span><span class="fu">error</span><span class="op">(</span>watchPath<span class="op">,</span> e<span class="op">.</span><span class="fu">getMessage</span><span class="op">());</span></span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> LoadedClassesState <span class="fu">captureLoadedClassesState</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> <span class="bu">Instrumentation</span> instrumentation <span class="op">=</span> <span class="fu">getInstrumentation</span><span class="op">();</span></span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> <span class="bu">Class</span><span class="op">&lt;?&gt;[]</span> loadedClasses <span class="op">=</span> instrumentation<span class="op">.</span><span class="fu">getAllLoadedClasses</span><span class="op">();</span></span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> <span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> ClassInfo<span class="op">&gt;</span> classInfoMap <span class="op">=</span> <span class="bu">Arrays</span><span class="op">.</span><span class="fu">stream</span><span class="op">(</span>loadedClasses<span class="op">)</span></span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">collect</span><span class="op">(</span>Collectors<span class="op">.</span><span class="fu">toMap</span><span class="op">(</span></span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>                <span class="bu">Class</span><span class="op">::</span>getName<span class="op">,</span></span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>                <span class="kw">this</span><span class="op">::</span>createClassInfo<span class="op">,</span></span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>                <span class="op">(</span>existing<span class="op">,</span> replacement<span class="op">)</span> <span class="op">-&gt;</span> existing  <span class="co">// Keep first in case of duplicates</span></span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>            <span class="op">));</span></span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">LoadedClassesState</span><span class="op">(</span></span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>            classInfoMap<span class="op">,</span></span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a>            loadedClasses<span class="op">.</span><span class="fu">length</span><span class="op">,</span></span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a>            <span class="fu">calculateClassLoaderHierarchy</span><span class="op">(),</span></span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>            Instant<span class="op">.</span><span class="fu">now</span><span class="op">()</span></span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong><strong>Runtime Behavior</strong></strong>: System state
capture creates comprehensive snapshots that enable precise system
reconstruction and debugging, particularly valuable for understanding
the context of critical events.</p>
<h2 id="step-1.4-causal-chain-analysis-and-tracking">Step 1.4: Causal
Chain Analysis and Tracking</h2>
<div class="sourceCode" id="cb5"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">// From: CausalChainAnalyzer.java (Domain Service)</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> CausalChainAnalyzer <span class="op">{</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> CausalAnalysisResult <span class="fu">analyzeCausalRelationships</span><span class="op">(</span><span class="dt">final</span> EnrichedEvent event<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Build causal chain for this event</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> CausalChain causalChain <span class="op">=</span> <span class="fu">buildCausalChain</span><span class="op">(</span>event<span class="op">);</span>  <span class="co">// ‚Üí Step 1.4a</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Analyze event influence and impact</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> InfluenceAnalysis influence <span class="op">=</span> <span class="fu">analyzeEventInfluence</span><span class="op">(</span>event<span class="op">,</span> causalChain<span class="op">);</span>  <span class="co">// ‚Üí Step 1.4b</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Detect causal patterns</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> <span class="bu">List</span><span class="op">&lt;</span>CausalPattern<span class="op">&gt;</span> patterns <span class="op">=</span> <span class="fu">detectCausalPatterns</span><span class="op">(</span>event<span class="op">,</span> causalChain<span class="op">);</span>  <span class="co">// ‚Üí Step 1.4c</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Update causal knowledge base</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">updateCausalKnowledge</span><span class="op">(</span>event<span class="op">,</span> causalChain<span class="op">,</span> influence<span class="op">,</span> patterns<span class="op">);</span>  <span class="co">// ‚Üí Step 1.4d</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">CausalAnalysisResult</span><span class="op">(</span>causalChain<span class="op">,</span> influence<span class="op">,</span> patterns<span class="op">);</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> CausalChain <span class="fu">buildCausalChain</span><span class="op">(</span><span class="dt">final</span> EnrichedEvent event<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> CausalChainBuilder builder <span class="op">=</span> <span class="kw">new</span> <span class="fu">CausalChainBuilder</span><span class="op">(</span>event<span class="op">);</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Find immediate causing events</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> <span class="bu">List</span><span class="op">&lt;</span>VersionedDomainEvent<span class="op">&gt;</span> immediateParents <span class="op">=</span> <span class="fu">findImmediateCausingEvents</span><span class="op">(</span>event<span class="op">);</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>        builder<span class="op">.</span><span class="fu">addImmediateParents</span><span class="op">(</span>immediateParents<span class="op">);</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Recursively build parent chains</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">final</span> VersionedDomainEvent parent <span class="op">:</span> immediateParents<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>            <span class="dt">final</span> CausalChain parentChain <span class="op">=</span> <span class="fu">getCachedCausalChain</span><span class="op">(</span>parent<span class="op">);</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>parentChain <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>                builder<span class="op">.</span><span class="fu">addParentChain</span><span class="op">(</span>parentChain<span class="op">);</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Recursively analyze parent if not cached</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>                <span class="dt">final</span> CausalChain newParentChain <span class="op">=</span> <span class="fu">buildCausalChain</span><span class="op">(</span><span class="fu">createEnrichedEvent</span><span class="op">(</span>parent<span class="op">));</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>                builder<span class="op">.</span><span class="fu">addParentChain</span><span class="op">(</span>newParentChain<span class="op">);</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>                <span class="fu">cacheCausalChain</span><span class="op">(</span>parent<span class="op">,</span> newParentChain<span class="op">);</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Find temporal correlations</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> <span class="bu">List</span><span class="op">&lt;</span>TemporalCorrelation<span class="op">&gt;</span> correlations <span class="op">=</span> <span class="fu">findTemporalCorrelations</span><span class="op">(</span>event<span class="op">);</span></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>        builder<span class="op">.</span><span class="fu">addTemporalCorrelations</span><span class="op">(</span>correlations<span class="op">);</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Calculate causal confidence scores</span></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> <span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Double</span><span class="op">&gt;</span> confidenceScores <span class="op">=</span> <span class="fu">calculateCausalConfidence</span><span class="op">(</span>event<span class="op">,</span> builder<span class="op">);</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>        builder<span class="op">.</span><span class="fu">addConfidenceScores</span><span class="op">(</span>confidenceScores<span class="op">);</span></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> builder<span class="op">.</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">List</span><span class="op">&lt;</span>VersionedDomainEvent<span class="op">&gt;</span> <span class="fu">findImmediateCausingEvents</span><span class="op">(</span><span class="dt">final</span> EnrichedEvent event<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> <span class="bu">List</span><span class="op">&lt;</span>VersionedDomainEvent<span class="op">&gt;</span> causingEvents <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;&gt;();</span></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check for explicit causation references</span></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>event<span class="op">.</span><span class="fu">getEvent</span><span class="op">().</span><span class="fu">getPreviousEventId</span><span class="op">()</span> <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>            <span class="dt">final</span> VersionedDomainEvent previousEvent <span class="op">=</span> <span class="fu">findEventById</span><span class="op">(</span>event<span class="op">.</span><span class="fu">getEvent</span><span class="op">().</span><span class="fu">getPreviousEventId</span><span class="op">());</span></span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>previousEvent <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>                causingEvents<span class="op">.</span><span class="fu">add</span><span class="op">(</span>previousEvent<span class="op">);</span></span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Analyze temporal causation (events within causal window)</span></span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> Instant eventTime <span class="op">=</span> event<span class="op">.</span><span class="fu">getMetadata</span><span class="op">().</span><span class="fu">getCaptureTimestamp</span><span class="op">();</span></span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> Instant causalWindowStart <span class="op">=</span> eventTime<span class="op">.</span><span class="fu">minus</span><span class="op">(</span>CAUSAL_WINDOW_DURATION<span class="op">);</span></span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> <span class="bu">List</span><span class="op">&lt;</span>VersionedDomainEvent<span class="op">&gt;</span> recentEvents <span class="op">=</span> <span class="fu">findEventsByTimeRange</span><span class="op">(</span></span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>            causalWindowStart<span class="op">,</span> </span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>            eventTime</span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Apply causal analysis heuristics</span></span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">final</span> VersionedDomainEvent recentEvent <span class="op">:</span> recentEvents<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span><span class="fu">isLikelyCausalRelationship</span><span class="op">(</span>recentEvent<span class="op">,</span> event<span class="op">.</span><span class="fu">getEvent</span><span class="op">()))</span> <span class="op">{</span></span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>                causingEvents<span class="op">.</span><span class="fu">add</span><span class="op">(</span>recentEvent<span class="op">);</span></span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> causingEvents<span class="op">;</span></span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">boolean</span> <span class="fu">isLikelyCausalRelationship</span><span class="op">(</span><span class="dt">final</span> VersionedDomainEvent cause<span class="op">,</span> </span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>                                              <span class="dt">final</span> VersionedDomainEvent effect<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Domain-specific causal relationship rules</span></span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>        <span class="co">// File change ‚Üí Validation relationship</span></span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>cause <span class="kw">instanceof</span> ClassFileChanged <span class="op">&amp;&amp;</span> effect <span class="kw">instanceof</span> BytecodeValidated<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a>            <span class="dt">final</span> ClassFileChanged fileChange <span class="op">=</span> <span class="op">(</span>ClassFileChanged<span class="op">)</span> cause<span class="op">;</span></span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a>            <span class="dt">final</span> BytecodeValidated validation <span class="op">=</span> <span class="op">(</span>BytecodeValidated<span class="op">)</span> effect<span class="op">;</span></span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> fileChange<span class="op">.</span><span class="fu">getClassFile</span><span class="op">().</span><span class="fu">equals</span><span class="op">(</span>validation<span class="op">.</span><span class="fu">getClassFile</span><span class="op">());</span></span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Validation ‚Üí Hot-swap relationship</span></span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>cause <span class="kw">instanceof</span> BytecodeValidated <span class="op">&amp;&amp;</span> effect <span class="kw">instanceof</span> HotSwapRequested<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a>            <span class="dt">final</span> BytecodeValidated validation <span class="op">=</span> <span class="op">(</span>BytecodeValidated<span class="op">)</span> cause<span class="op">;</span></span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a>            <span class="dt">final</span> HotSwapRequested hotSwap <span class="op">=</span> <span class="op">(</span>HotSwapRequested<span class="op">)</span> effect<span class="op">;</span></span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> validation<span class="op">.</span><span class="fu">getClassName</span><span class="op">().</span><span class="fu">equals</span><span class="op">(</span>hotSwap<span class="op">.</span><span class="fu">getClassName</span><span class="op">());</span></span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Hot-swap request ‚Üí Result relationship</span></span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>cause <span class="kw">instanceof</span> HotSwapRequested <span class="op">&amp;&amp;</span> </span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a>           <span class="op">(</span>effect <span class="kw">instanceof</span> ClassRedefinitionSucceeded <span class="op">||</span> effect <span class="kw">instanceof</span> ClassRedefinitionFailed<span class="op">))</span> <span class="op">{</span></span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a>            <span class="dt">final</span> HotSwapRequested request <span class="op">=</span> <span class="op">(</span>HotSwapRequested<span class="op">)</span> cause<span class="op">;</span></span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> request<span class="op">.</span><span class="fu">getClassName</span><span class="op">().</span><span class="fu">equals</span><span class="op">(</span><span class="fu">getClassName</span><span class="op">(</span>effect<span class="op">));</span></span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a>        <span class="co">// User action ‚Üí System response relationship</span></span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span><span class="fu">isUserActionEvent</span><span class="op">(</span>cause<span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu">isSystemResponseEvent</span><span class="op">(</span>effect<span class="op">))</span> <span class="op">{</span></span>
<span id="cb5-108"><a href="#cb5-108" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fu">isWithinUserActionScope</span><span class="op">(</span>cause<span class="op">,</span> effect<span class="op">);</span></span>
<span id="cb5-109"><a href="#cb5-109" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb5-110"><a href="#cb5-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-111"><a href="#cb5-111" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb5-112"><a href="#cb5-112" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-113"><a href="#cb5-113" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong><strong>Runtime Behavior</strong></strong>: Causal chain
analysis builds sophisticated understanding of event relationships,
enabling ByteHot to understand not just what happened, but why it
happened and what influence it had on subsequent events.</p>
<h1 id="phase-2-event-serialization-and-storage-preparation">Phase 2:
Event Serialization and Storage Preparation</h1>
<p>Events are prepared for persistent storage through sophisticated
serialization that preserves all domain information and metadata.</p>
<h2 id="step-2.1-event-serialization-pipeline">Step 2.1: Event
Serialization Pipeline</h2>
<div class="sourceCode" id="cb6"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">// From: EventSerializationPipeline.java (Infrastructure Layer)</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> EventSerializationPipeline <span class="op">{</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> SerializedEvent <span class="fu">serializeEvent</span><span class="op">(</span><span class="dt">final</span> EnrichedEvent enrichedEvent<span class="op">)</span> <span class="kw">throws</span> SerializationException <span class="op">{</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Convert domain event to DTO</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>            <span class="dt">final</span> <span class="bu">Object</span> eventDTO <span class="op">=</span> <span class="fu">convertToDTO</span><span class="op">(</span>enrichedEvent<span class="op">.</span><span class="fu">getEvent</span><span class="op">());</span>  <span class="co">// ‚Üí Step 2.1a</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Serialize metadata</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>            <span class="dt">final</span> <span class="bu">String</span> metadataJson <span class="op">=</span> <span class="fu">serializeMetadata</span><span class="op">(</span>enrichedEvent<span class="op">.</span><span class="fu">getMetadata</span><span class="op">());</span>  <span class="co">// ‚Üí Step 2.1b</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Serialize event data</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>            <span class="dt">final</span> <span class="bu">String</span> eventDataJson <span class="op">=</span> <span class="fu">serializeEventData</span><span class="op">(</span>eventDTO<span class="op">);</span>  <span class="co">// ‚Üí Step 2.1c</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Create composite JSON structure</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>            <span class="dt">final</span> <span class="bu">String</span> compositeJson <span class="op">=</span> <span class="fu">createCompositeJson</span><span class="op">(</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>                enrichedEvent<span class="op">.</span><span class="fu">getEvent</span><span class="op">().</span><span class="fu">getEventType</span><span class="op">(),</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>                metadataJson<span class="op">,</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>                eventDataJson</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>            <span class="op">);</span>  <span class="co">// ‚Üí Step 2.1d</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Validate serialization integrity</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>            <span class="fu">validateSerialization</span><span class="op">(</span>enrichedEvent<span class="op">,</span> compositeJson<span class="op">);</span>  <span class="co">// ‚Üí Step 2.1e</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">new</span> <span class="fu">SerializedEvent</span><span class="op">(</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>                enrichedEvent<span class="op">.</span><span class="fu">getEvent</span><span class="op">().</span><span class="fu">getEventId</span><span class="op">(),</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>                enrichedEvent<span class="op">.</span><span class="fu">getEvent</span><span class="op">().</span><span class="fu">getEventType</span><span class="op">(),</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>                compositeJson<span class="op">,</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>                <span class="fu">calculateSerializationChecksum</span><span class="op">(</span>compositeJson<span class="op">),</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>                Instant<span class="op">.</span><span class="fu">now</span><span class="op">()</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>            <span class="op">);</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="dt">final</span> <span class="bu">Exception</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">SerializationException</span><span class="op">(</span><span class="st">&quot;Failed to serialize event&quot;</span><span class="op">,</span> e<span class="op">,</span> enrichedEvent<span class="op">.</span><span class="fu">getEvent</span><span class="op">());</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Object</span> <span class="fu">convertToDTO</span><span class="op">(</span><span class="dt">final</span> VersionedDomainEvent event<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Use type-specific DTO converters</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>event <span class="kw">instanceof</span> ClassFileChanged classFileEvent<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> JsonClassFileChanged<span class="op">.</span><span class="fu">fromDomain</span><span class="op">(</span>classFileEvent<span class="op">);</span>  <span class="co">// ‚Üí Step 2.1f</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>event <span class="kw">instanceof</span> BytecodeValidated validationEvent<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> JsonBytecodeValidated<span class="op">.</span><span class="fu">fromDomain</span><span class="op">(</span>validationEvent<span class="op">);</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>event <span class="kw">instanceof</span> HotSwapRequested hotSwapEvent<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> JsonHotSwapRequested<span class="op">.</span><span class="fu">fromDomain</span><span class="op">(</span>hotSwapEvent<span class="op">);</span></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>event <span class="kw">instanceof</span> ClassRedefinitionSucceeded successEvent<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> JsonClassRedefinitionSucceeded<span class="op">.</span><span class="fu">fromDomain</span><span class="op">(</span>successEvent<span class="op">);</span></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>event <span class="kw">instanceof</span> ClassRedefinitionFailed failureEvent<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> JsonClassRedefinitionFailed<span class="op">.</span><span class="fu">fromDomain</span><span class="op">(</span>failureEvent<span class="op">);</span></span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Fallback to generic serialization for unknown event types</span></span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fu">createGenericEventDTO</span><span class="op">(</span>event<span class="op">);</span></span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> <span class="fu">createCompositeJson</span><span class="op">(</span><span class="dt">final</span> <span class="bu">String</span> eventType<span class="op">,</span> </span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>                                      <span class="dt">final</span> <span class="bu">String</span> metadataJson<span class="op">,</span> </span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>                                      <span class="dt">final</span> <span class="bu">String</span> eventDataJson<span class="op">)</span> <span class="kw">throws</span> JsonProcessingException <span class="op">{</span></span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> ObjectNode rootNode <span class="op">=</span> objectMapper<span class="op">.</span><span class="fu">createObjectNode</span><span class="op">();</span></span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Add schema version for future compatibility</span></span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>        rootNode<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;schemaVersion&quot;</span><span class="op">,</span> CURRENT_SCHEMA_VERSION<span class="op">);</span></span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Add event type information</span></span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>        rootNode<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;eventType&quot;</span><span class="op">,</span> eventType<span class="op">);</span></span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Add serialization timestamp</span></span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a>        rootNode<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;serializedAt&quot;</span><span class="op">,</span> Instant<span class="op">.</span><span class="fu">now</span><span class="op">().</span><span class="fu">toString</span><span class="op">());</span></span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Add metadata as parsed JSON</span></span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a>        rootNode<span class="op">.</span><span class="fu">set</span><span class="op">(</span><span class="st">&quot;metadata&quot;</span><span class="op">,</span> objectMapper<span class="op">.</span><span class="fu">readTree</span><span class="op">(</span>metadataJson<span class="op">));</span></span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Add event data as parsed JSON</span></span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>        rootNode<span class="op">.</span><span class="fu">set</span><span class="op">(</span><span class="st">&quot;eventData&quot;</span><span class="op">,</span> objectMapper<span class="op">.</span><span class="fu">readTree</span><span class="op">(</span>eventDataJson<span class="op">));</span></span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Add serialization integrity markers</span></span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>        rootNode<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;serializationId&quot;</span><span class="op">,</span> <span class="fu">generateSerializationId</span><span class="op">());</span></span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>        rootNode<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;serializationChecksum&quot;</span><span class="op">,</span> <span class="fu">calculateSerializationChecksum</span><span class="op">(</span>metadataJson <span class="op">+</span> eventDataJson<span class="op">));</span></span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> objectMapper<span class="op">.</span><span class="fu">writeValueAsString</span><span class="op">(</span>rootNode<span class="op">);</span></span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong><strong>Runtime Behavior</strong></strong>: Event
serialization creates comprehensive JSON structures that preserve all
domain information, metadata, and integrity markers needed for reliable
persistence and future deserialization.</p>
<h2 id="step-2.2-storage-strategy-and-organization">Step 2.2: Storage
Strategy and Organization</h2>
<div class="sourceCode" id="cb7"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">// From: EventStorageStrategy.java (Infrastructure Layer)</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> EventStorageStrategy <span class="op">{</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> StorageLocation <span class="fu">determineStorageLocation</span><span class="op">(</span><span class="dt">final</span> SerializedEvent serializedEvent<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Hierarchical storage organization based on multiple factors</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> StorageHierarchy hierarchy <span class="op">=</span> <span class="fu">buildStorageHierarchy</span><span class="op">(</span>serializedEvent<span class="op">);</span>  <span class="co">// ‚Üí Step 2.2a</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Determine storage partition based on event characteristics</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> StoragePartition partition <span class="op">=</span> <span class="fu">determineStoragePartition</span><span class="op">(</span>serializedEvent<span class="op">);</span>  <span class="co">// ‚Üí Step 2.2b</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Calculate optimal storage path</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> Path storagePath <span class="op">=</span> <span class="fu">calculateStoragePath</span><span class="op">(</span>hierarchy<span class="op">,</span> partition<span class="op">);</span>  <span class="co">// ‚Üí Step 2.2c</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Generate unique filename with metadata</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> <span class="bu">String</span> filename <span class="op">=</span> <span class="fu">generateEventFilename</span><span class="op">(</span>serializedEvent<span class="op">);</span>  <span class="co">// ‚Üí Step 2.2d</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">StorageLocation</span><span class="op">(</span>storagePath<span class="op">,</span> filename<span class="op">,</span> partition<span class="op">);</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> StorageHierarchy <span class="fu">buildStorageHierarchy</span><span class="op">(</span><span class="dt">final</span> SerializedEvent serializedEvent<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> StorageHierarchyBuilder builder <span class="op">=</span> <span class="kw">new</span> <span class="fu">StorageHierarchyBuilder</span><span class="op">();</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Organize by year/month for temporal access</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> Instant eventTime <span class="op">=</span> serializedEvent<span class="op">.</span><span class="fu">getTimestamp</span><span class="op">();</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> LocalDateTime dateTime <span class="op">=</span> LocalDateTime<span class="op">.</span><span class="fu">ofInstant</span><span class="op">(</span>eventTime<span class="op">,</span> ZoneOffset<span class="op">.</span><span class="fu">UTC</span><span class="op">);</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>        builder<span class="op">.</span><span class="fu">addTemporalHierarchy</span><span class="op">(</span>dateTime<span class="op">.</span><span class="fu">getYear</span><span class="op">(),</span> dateTime<span class="op">.</span><span class="fu">getMonthValue</span><span class="op">());</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Organize by event type for functional access</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> <span class="bu">String</span> eventType <span class="op">=</span> serializedEvent<span class="op">.</span><span class="fu">getEventType</span><span class="op">();</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>        builder<span class="op">.</span><span class="fu">addFunctionalHierarchy</span><span class="op">(</span>eventType<span class="op">);</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Organize by aggregate for entity-based access</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>serializedEvent<span class="op">.</span><span class="fu">hasAggregateInformation</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>            builder<span class="op">.</span><span class="fu">addAggregateHierarchy</span><span class="op">(</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>                serializedEvent<span class="op">.</span><span class="fu">getAggregateType</span><span class="op">(),</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>                serializedEvent<span class="op">.</span><span class="fu">getAggregateId</span><span class="op">()</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>            <span class="op">);</span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Organize by user for user-specific access</span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>serializedEvent<span class="op">.</span><span class="fu">hasUserInformation</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>            builder<span class="op">.</span><span class="fu">addUserHierarchy</span><span class="op">(</span>serializedEvent<span class="op">.</span><span class="fu">getUserId</span><span class="op">());</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> builder<span class="op">.</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> StoragePartition <span class="fu">determineStoragePartition</span><span class="op">(</span><span class="dt">final</span> SerializedEvent serializedEvent<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Determine partition based on event characteristics and access patterns</span></span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Hot partition for recent, frequently accessed events</span></span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span><span class="fu">isRecentEvent</span><span class="op">(</span>serializedEvent<span class="op">)</span> <span class="op">||</span> <span class="fu">isHighAccessEvent</span><span class="op">(</span>serializedEvent<span class="op">))</span> <span class="op">{</span></span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> StoragePartition<span class="op">.</span><span class="fu">HOT</span><span class="op">;</span></span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Warm partition for moderately recent events</span></span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span><span class="fu">isModeratelyRecentEvent</span><span class="op">(</span>serializedEvent<span class="op">))</span> <span class="op">{</span></span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> StoragePartition<span class="op">.</span><span class="fu">WARM</span><span class="op">;</span></span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Cold partition for archival events</span></span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span><span class="fu">isArchivalEvent</span><span class="op">(</span>serializedEvent<span class="op">))</span> <span class="op">{</span></span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> StoragePartition<span class="op">.</span><span class="fu">COLD</span><span class="op">;</span></span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Critical partition for events requiring high availability</span></span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span><span class="fu">isCriticalEvent</span><span class="op">(</span>serializedEvent<span class="op">))</span> <span class="op">{</span></span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> StoragePartition<span class="op">.</span><span class="fu">CRITICAL</span><span class="op">;</span></span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> StoragePartition<span class="op">.</span><span class="fu">STANDARD</span><span class="op">;</span></span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> <span class="fu">generateEventFilename</span><span class="op">(</span><span class="dt">final</span> SerializedEvent serializedEvent<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> <span class="bu">StringBuilder</span> filename <span class="op">=</span> <span class="kw">new</span> <span class="bu">StringBuilder</span><span class="op">();</span></span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Timestamp prefix for chronological ordering</span></span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> Instant timestamp <span class="op">=</span> serializedEvent<span class="op">.</span><span class="fu">getTimestamp</span><span class="op">();</span></span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a>        filename<span class="op">.</span><span class="fu">append</span><span class="op">(</span>timestamp<span class="op">.</span><span class="fu">getEpochSecond</span><span class="op">()).</span><span class="fu">append</span><span class="op">(</span><span class="st">&quot;_&quot;</span><span class="op">);</span></span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a>        filename<span class="op">.</span><span class="fu">append</span><span class="op">(</span>timestamp<span class="op">.</span><span class="fu">getNano</span><span class="op">()).</span><span class="fu">append</span><span class="op">(</span><span class="st">&quot;_&quot;</span><span class="op">);</span></span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-82"><a href="#cb7-82" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Event type for functional identification</span></span>
<span id="cb7-83"><a href="#cb7-83" aria-hidden="true" tabindex="-1"></a>        filename<span class="op">.</span><span class="fu">append</span><span class="op">(</span>serializedEvent<span class="op">.</span><span class="fu">getEventType</span><span class="op">()).</span><span class="fu">append</span><span class="op">(</span><span class="st">&quot;_&quot;</span><span class="op">);</span></span>
<span id="cb7-84"><a href="#cb7-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-85"><a href="#cb7-85" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Event ID for unique identification</span></span>
<span id="cb7-86"><a href="#cb7-86" aria-hidden="true" tabindex="-1"></a>        filename<span class="op">.</span><span class="fu">append</span><span class="op">(</span>serializedEvent<span class="op">.</span><span class="fu">getEventId</span><span class="op">()).</span><span class="fu">append</span><span class="op">(</span><span class="st">&quot;_&quot;</span><span class="op">);</span></span>
<span id="cb7-87"><a href="#cb7-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-88"><a href="#cb7-88" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Version for schema evolution</span></span>
<span id="cb7-89"><a href="#cb7-89" aria-hidden="true" tabindex="-1"></a>        filename<span class="op">.</span><span class="fu">append</span><span class="op">(</span><span class="st">&quot;v&quot;</span><span class="op">).</span><span class="fu">append</span><span class="op">(</span>CURRENT_SCHEMA_VERSION<span class="op">);</span></span>
<span id="cb7-90"><a href="#cb7-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-91"><a href="#cb7-91" aria-hidden="true" tabindex="-1"></a>        <span class="co">// JSON extension</span></span>
<span id="cb7-92"><a href="#cb7-92" aria-hidden="true" tabindex="-1"></a>        filename<span class="op">.</span><span class="fu">append</span><span class="op">(</span><span class="st">&quot;.json&quot;</span><span class="op">);</span></span>
<span id="cb7-93"><a href="#cb7-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-94"><a href="#cb7-94" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> filename<span class="op">.</span><span class="fu">toString</span><span class="op">();</span></span>
<span id="cb7-95"><a href="#cb7-95" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-96"><a href="#cb7-96" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong><strong>Runtime Behavior</strong></strong>: Storage strategy
creates intelligent hierarchical organization that optimizes for
different access patterns while maintaining performance and enabling
efficient querying.</p>
<h1 id="phase-3-persistent-storage-and-index-management">Phase 3:
Persistent Storage and Index Management</h1>
<p>Events are physically stored with comprehensive indexing to enable
fast retrieval and analysis.</p>
<h2 id="step-3.1-file-system-event-storage">Step 3.1: File System Event
Storage</h2>
<div class="sourceCode" id="cb8"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">// From: FilesystemEventStoreAdapter.java (Infrastructure Layer)</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Override</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">save</span><span class="op">(</span><span class="dt">final</span> VersionedDomainEvent event<span class="op">)</span> <span class="kw">throws</span> EventStoreException <span class="op">{</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Serialize event through pipeline</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> EnrichedEvent enrichedEvent <span class="op">=</span> <span class="fu">enrichEvent</span><span class="op">(</span>event<span class="op">);</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> SerializedEvent serializedEvent <span class="op">=</span> <span class="fu">serializeEvent</span><span class="op">(</span>enrichedEvent<span class="op">);</span>  <span class="co">// ‚Üí Phase 2</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Determine storage location</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> StorageLocation location <span class="op">=</span> storageStrategy<span class="op">.</span><span class="fu">determineStorageLocation</span><span class="op">(</span>serializedEvent<span class="op">);</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Ensure directory structure exists</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">createDirectoryStructure</span><span class="op">(</span>location<span class="op">);</span>  <span class="co">// ‚Üí Step 3.1a</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Write event with atomic operations</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">writeEventAtomically</span><span class="op">(</span>serializedEvent<span class="op">,</span> location<span class="op">);</span>  <span class="co">// ‚Üí Step 3.1b</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Update indices for fast retrieval</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>        <span class="fu">updateEventIndices</span><span class="op">(</span>serializedEvent<span class="op">,</span> location<span class="op">);</span>  <span class="co">// ‚Üí Step 3.1c</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Update aggregate version tracking</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>        <span class="fu">updateAggregateVersion</span><span class="op">(</span>event<span class="op">);</span>  <span class="co">// ‚Üí Step 3.1d</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Trigger background maintenance if needed</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>        <span class="fu">scheduleMaintenanceIfNeeded</span><span class="op">();</span>  <span class="co">// ‚Üí Step 3.1e</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="dt">final</span> <span class="bu">Exception</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">EventStoreException</span><span class="op">(</span><span class="st">&quot;Failed to save event&quot;</span><span class="op">,</span> e<span class="op">,</span> event<span class="op">);</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">void</span> <span class="fu">createDirectoryStructure</span><span class="op">(</span><span class="dt">final</span> StorageLocation location<span class="op">)</span> <span class="kw">throws</span> <span class="bu">IOException</span> <span class="op">{</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>    <span class="dt">final</span> Path directoryPath <span class="op">=</span> location<span class="op">.</span><span class="fu">getPath</span><span class="op">();</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>Files<span class="op">.</span><span class="fu">exists</span><span class="op">(</span>directoryPath<span class="op">))</span> <span class="op">{</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Create directory structure with proper permissions</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>        Files<span class="op">.</span><span class="fu">createDirectories</span><span class="op">(</span>directoryPath<span class="op">);</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Set appropriate permissions for security</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>        <span class="fu">setDirectoryPermissions</span><span class="op">(</span>directoryPath<span class="op">);</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Create index files for new directories</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>        <span class="fu">createDirectoryIndices</span><span class="op">(</span>directoryPath<span class="op">);</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">void</span> <span class="fu">writeEventAtomically</span><span class="op">(</span><span class="dt">final</span> SerializedEvent serializedEvent<span class="op">,</span> </span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>                                 <span class="dt">final</span> StorageLocation location<span class="op">)</span> <span class="kw">throws</span> <span class="bu">IOException</span> <span class="op">{</span></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>    <span class="dt">final</span> Path eventFilePath <span class="op">=</span> location<span class="op">.</span><span class="fu">getPath</span><span class="op">().</span><span class="fu">resolve</span><span class="op">(</span>location<span class="op">.</span><span class="fu">getFilename</span><span class="op">());</span></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>    <span class="dt">final</span> Path tempFilePath <span class="op">=</span> location<span class="op">.</span><span class="fu">getPath</span><span class="op">().</span><span class="fu">resolve</span><span class="op">(</span>location<span class="op">.</span><span class="fu">getFilename</span><span class="op">()</span> <span class="op">+</span> <span class="st">&quot;.tmp&quot;</span><span class="op">);</span></span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Write to temporary file first</span></span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>        Files<span class="op">.</span><span class="fu">write</span><span class="op">(</span>tempFilePath<span class="op">,</span> </span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>                   serializedEvent<span class="op">.</span><span class="fu">getJsonData</span><span class="op">().</span><span class="fu">getBytes</span><span class="op">(</span>StandardCharsets<span class="op">.</span><span class="fu">UTF_8</span><span class="op">),</span></span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>                   StandardOpenOption<span class="op">.</span><span class="fu">CREATE</span><span class="op">,</span> </span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>                   StandardOpenOption<span class="op">.</span><span class="fu">WRITE</span><span class="op">);</span></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Verify written data integrity</span></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>        <span class="fu">verifyWrittenData</span><span class="op">(</span>tempFilePath<span class="op">,</span> serializedEvent<span class="op">);</span></span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Atomic move to final location</span></span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>        Files<span class="op">.</span><span class="fu">move</span><span class="op">(</span>tempFilePath<span class="op">,</span> eventFilePath<span class="op">,</span> StandardCopyOption<span class="op">.</span><span class="fu">ATOMIC_MOVE</span><span class="op">);</span></span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Set file permissions</span></span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>        <span class="fu">setFilePermissions</span><span class="op">(</span>eventFilePath<span class="op">);</span></span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="dt">final</span> <span class="bu">Exception</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Clean up temporary file on failure</span></span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>        Files<span class="op">.</span><span class="fu">deleteIfExists</span><span class="op">(</span>tempFilePath<span class="op">);</span></span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>        <span class="cf">throw</span> e<span class="op">;</span></span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong><strong>Runtime Behavior</strong></strong>: File system
storage uses atomic operations and comprehensive error handling to
ensure data integrity even in the face of system failures or concurrent
access.</p>
<h2 id="step-3.2-event-index-management">Step 3.2: Event Index
Management</h2>
<div class="sourceCode" id="cb9"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">// From: EventIndexManager.java (Infrastructure Layer)</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> EventIndexManager <span class="op">{</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">updateEventIndices</span><span class="op">(</span><span class="dt">final</span> SerializedEvent serializedEvent<span class="op">,</span> </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>                                  <span class="dt">final</span> StorageLocation location<span class="op">)</span> <span class="kw">throws</span> IndexException <span class="op">{</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Update temporal index for time-based queries</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>            <span class="fu">updateTemporalIndex</span><span class="op">(</span>serializedEvent<span class="op">,</span> location<span class="op">);</span>  <span class="co">// ‚Üí Step 3.2a</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Update type index for event type queries</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>            <span class="fu">updateTypeIndex</span><span class="op">(</span>serializedEvent<span class="op">,</span> location<span class="op">);</span>  <span class="co">// ‚Üí Step 3.2b</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Update aggregate index for entity-based queries</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>            <span class="fu">updateAggregateIndex</span><span class="op">(</span>serializedEvent<span class="op">,</span> location<span class="op">);</span>  <span class="co">// ‚Üí Step 3.2c</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Update causal index for relationship queries</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>            <span class="fu">updateCausalIndex</span><span class="op">(</span>serializedEvent<span class="op">,</span> location<span class="op">);</span>  <span class="co">// ‚Üí Step 3.2d</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Update user index for user-specific queries</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>            <span class="fu">updateUserIndex</span><span class="op">(</span>serializedEvent<span class="op">,</span> location<span class="op">);</span>  <span class="co">// ‚Üí Step 3.2e</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Update full-text index for content searches</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>            <span class="fu">updateFullTextIndex</span><span class="op">(</span>serializedEvent<span class="op">,</span> location<span class="op">);</span>  <span class="co">// ‚Üí Step 3.2f</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="dt">final</span> <span class="bu">Exception</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">IndexException</span><span class="op">(</span><span class="st">&quot;Failed to update event indices&quot;</span><span class="op">,</span> e<span class="op">,</span> serializedEvent<span class="op">);</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">updateTemporalIndex</span><span class="op">(</span><span class="dt">final</span> SerializedEvent serializedEvent<span class="op">,</span> </span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>                                    <span class="dt">final</span> StorageLocation location<span class="op">)</span> <span class="kw">throws</span> <span class="bu">IOException</span> <span class="op">{</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> TemporalIndex temporalIndex <span class="op">=</span> <span class="fu">getTemporalIndex</span><span class="op">(</span>location<span class="op">.</span><span class="fu">getPartition</span><span class="op">());</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Add event to time-based B-tree index</span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> IndexEntry entry <span class="op">=</span> <span class="kw">new</span> <span class="fu">IndexEntry</span><span class="op">(</span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>            serializedEvent<span class="op">.</span><span class="fu">getEventId</span><span class="op">(),</span></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>            serializedEvent<span class="op">.</span><span class="fu">getTimestamp</span><span class="op">(),</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>            location<span class="op">.</span><span class="fu">getFullPath</span><span class="op">(),</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>            serializedEvent<span class="op">.</span><span class="fu">getEventType</span><span class="op">()</span></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>        temporalIndex<span class="op">.</span><span class="fu">insert</span><span class="op">(</span>entry<span class="op">);</span></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Update time-range summaries for query optimization</span></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>        <span class="fu">updateTimeRangeSummaries</span><span class="op">(</span>temporalIndex<span class="op">,</span> serializedEvent<span class="op">);</span></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">updateAggregateIndex</span><span class="op">(</span><span class="dt">final</span> SerializedEvent serializedEvent<span class="op">,</span> </span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>                                     <span class="dt">final</span> StorageLocation location<span class="op">)</span> <span class="kw">throws</span> <span class="bu">IOException</span> <span class="op">{</span></span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>serializedEvent<span class="op">.</span><span class="fu">hasAggregateInformation</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span><span class="op">;</span></span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> AggregateIndex aggregateIndex <span class="op">=</span> <span class="fu">getAggregateIndex</span><span class="op">(</span>location<span class="op">.</span><span class="fu">getPartition</span><span class="op">());</span></span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> <span class="bu">String</span> aggregateKey <span class="op">=</span> <span class="fu">createAggregateKey</span><span class="op">(</span></span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>            serializedEvent<span class="op">.</span><span class="fu">getAggregateType</span><span class="op">(),</span></span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>            serializedEvent<span class="op">.</span><span class="fu">getAggregateId</span><span class="op">()</span></span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Add to aggregate-specific event stream</span></span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> AggregateStreamEntry streamEntry <span class="op">=</span> <span class="kw">new</span> <span class="fu">AggregateStreamEntry</span><span class="op">(</span></span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>            serializedEvent<span class="op">.</span><span class="fu">getEventId</span><span class="op">(),</span></span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>            serializedEvent<span class="op">.</span><span class="fu">getAggregateVersion</span><span class="op">(),</span></span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>            serializedEvent<span class="op">.</span><span class="fu">getTimestamp</span><span class="op">(),</span></span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>            location<span class="op">.</span><span class="fu">getFullPath</span><span class="op">()</span></span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>        aggregateIndex<span class="op">.</span><span class="fu">addToStream</span><span class="op">(</span>aggregateKey<span class="op">,</span> streamEntry<span class="op">);</span></span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Update aggregate version tracking</span></span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a>        aggregateIndex<span class="op">.</span><span class="fu">updateVersion</span><span class="op">(</span>aggregateKey<span class="op">,</span> serializedEvent<span class="op">.</span><span class="fu">getAggregateVersion</span><span class="op">());</span></span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">updateCausalIndex</span><span class="op">(</span><span class="dt">final</span> SerializedEvent serializedEvent<span class="op">,</span> </span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a>                                  <span class="dt">final</span> StorageLocation location<span class="op">)</span> <span class="kw">throws</span> <span class="bu">IOException</span> <span class="op">{</span></span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> CausalIndex causalIndex <span class="op">=</span> <span class="fu">getCausalIndex</span><span class="op">(</span>location<span class="op">.</span><span class="fu">getPartition</span><span class="op">());</span></span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Index causal relationships</span></span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>serializedEvent<span class="op">.</span><span class="fu">hasCausalInformation</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a>            <span class="dt">final</span> <span class="bu">List</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> causingEventIds <span class="op">=</span> serializedEvent<span class="op">.</span><span class="fu">getCausingEventIds</span><span class="op">();</span></span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="op">(</span><span class="dt">final</span> <span class="bu">String</span> causingEventId <span class="op">:</span> causingEventIds<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a>                causalIndex<span class="op">.</span><span class="fu">addCausalRelationship</span><span class="op">(</span></span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a>                    causingEventId<span class="op">,</span></span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true" tabindex="-1"></a>                    serializedEvent<span class="op">.</span><span class="fu">getEventId</span><span class="op">(),</span></span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">calculateCausalStrength</span><span class="op">(</span>causingEventId<span class="op">,</span> serializedEvent<span class="op">)</span></span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true" tabindex="-1"></a>                <span class="op">);</span></span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb9-90"><a href="#cb9-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-91"><a href="#cb9-91" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Index temporal correlations</span></span>
<span id="cb9-92"><a href="#cb9-92" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> <span class="bu">List</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> correlatedEventIds <span class="op">=</span> <span class="fu">findTemporalCorrelations</span><span class="op">(</span>serializedEvent<span class="op">);</span></span>
<span id="cb9-93"><a href="#cb9-93" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">final</span> <span class="bu">String</span> correlatedEventId <span class="op">:</span> correlatedEventIds<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-94"><a href="#cb9-94" aria-hidden="true" tabindex="-1"></a>            causalIndex<span class="op">.</span><span class="fu">addTemporalCorrelation</span><span class="op">(</span></span>
<span id="cb9-95"><a href="#cb9-95" aria-hidden="true" tabindex="-1"></a>                correlatedEventId<span class="op">,</span></span>
<span id="cb9-96"><a href="#cb9-96" aria-hidden="true" tabindex="-1"></a>                serializedEvent<span class="op">.</span><span class="fu">getEventId</span><span class="op">(),</span></span>
<span id="cb9-97"><a href="#cb9-97" aria-hidden="true" tabindex="-1"></a>                <span class="fu">calculateCorrelationStrength</span><span class="op">(</span>correlatedEventId<span class="op">,</span> serializedEvent<span class="op">)</span></span>
<span id="cb9-98"><a href="#cb9-98" aria-hidden="true" tabindex="-1"></a>            <span class="op">);</span></span>
<span id="cb9-99"><a href="#cb9-99" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb9-100"><a href="#cb9-100" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-101"><a href="#cb9-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-102"><a href="#cb9-102" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">updateFullTextIndex</span><span class="op">(</span><span class="dt">final</span> SerializedEvent serializedEvent<span class="op">,</span> </span>
<span id="cb9-103"><a href="#cb9-103" aria-hidden="true" tabindex="-1"></a>                                    <span class="dt">final</span> StorageLocation location<span class="op">)</span> <span class="kw">throws</span> <span class="bu">IOException</span> <span class="op">{</span></span>
<span id="cb9-104"><a href="#cb9-104" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> FullTextIndex fullTextIndex <span class="op">=</span> <span class="fu">getFullTextIndex</span><span class="op">(</span>location<span class="op">.</span><span class="fu">getPartition</span><span class="op">());</span></span>
<span id="cb9-105"><a href="#cb9-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-106"><a href="#cb9-106" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Extract searchable text from event</span></span>
<span id="cb9-107"><a href="#cb9-107" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> <span class="bu">String</span> searchableText <span class="op">=</span> <span class="fu">extractSearchableText</span><span class="op">(</span>serializedEvent<span class="op">);</span></span>
<span id="cb9-108"><a href="#cb9-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-109"><a href="#cb9-109" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Tokenize and index</span></span>
<span id="cb9-110"><a href="#cb9-110" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> <span class="bu">List</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> tokens <span class="op">=</span> <span class="fu">tokenizeText</span><span class="op">(</span>searchableText<span class="op">);</span></span>
<span id="cb9-111"><a href="#cb9-111" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">final</span> <span class="bu">String</span> token <span class="op">:</span> tokens<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-112"><a href="#cb9-112" aria-hidden="true" tabindex="-1"></a>            fullTextIndex<span class="op">.</span><span class="fu">addTokenReference</span><span class="op">(</span></span>
<span id="cb9-113"><a href="#cb9-113" aria-hidden="true" tabindex="-1"></a>                token<span class="op">,</span></span>
<span id="cb9-114"><a href="#cb9-114" aria-hidden="true" tabindex="-1"></a>                serializedEvent<span class="op">.</span><span class="fu">getEventId</span><span class="op">(),</span></span>
<span id="cb9-115"><a href="#cb9-115" aria-hidden="true" tabindex="-1"></a>                location<span class="op">.</span><span class="fu">getFullPath</span><span class="op">(),</span></span>
<span id="cb9-116"><a href="#cb9-116" aria-hidden="true" tabindex="-1"></a>                <span class="fu">calculateTokenRelevance</span><span class="op">(</span>token<span class="op">,</span> serializedEvent<span class="op">)</span></span>
<span id="cb9-117"><a href="#cb9-117" aria-hidden="true" tabindex="-1"></a>            <span class="op">);</span></span>
<span id="cb9-118"><a href="#cb9-118" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb9-119"><a href="#cb9-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-120"><a href="#cb9-120" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Index structured fields</span></span>
<span id="cb9-121"><a href="#cb9-121" aria-hidden="true" tabindex="-1"></a>        <span class="fu">indexStructuredFields</span><span class="op">(</span>fullTextIndex<span class="op">,</span> serializedEvent<span class="op">,</span> location<span class="op">);</span></span>
<span id="cb9-122"><a href="#cb9-122" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-123"><a href="#cb9-123" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong><strong>Runtime Behavior</strong></strong>: Index management
creates multiple specialized indices that enable fast querying across
different dimensions: time, event type, aggregate, causal relationships,
users, and content.</p>
<h1 id="phase-4-event-retrieval-and-replay-capabilities">Phase 4: Event
Retrieval and Replay Capabilities</h1>
<p>The stored events can be efficiently retrieved and replayed for
debugging, analysis, and system reconstruction.</p>
<h2 id="step-4.1-event-query-engine">Step 4.1: Event Query Engine</h2>
<div class="sourceCode" id="cb10"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">// From: EventQueryEngine.java (Infrastructure Layer)</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> EventQueryEngine <span class="op">{</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> CompletableFuture<span class="op">&lt;</span><span class="bu">List</span><span class="op">&lt;</span>VersionedDomainEvent<span class="op">&gt;&gt;</span> <span class="fu">executeQuery</span><span class="op">(</span><span class="dt">final</span> EventQuery query<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> CompletableFuture<span class="op">.</span><span class="fu">supplyAsync</span><span class="op">(()</span> <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Optimize query using available indices</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>                <span class="dt">final</span> OptimizedQuery optimizedQuery <span class="op">=</span> <span class="fu">optimizeQuery</span><span class="op">(</span>query<span class="op">);</span>  <span class="co">// ‚Üí Step 4.1a</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Execute query against appropriate indices</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>                <span class="dt">final</span> <span class="bu">List</span><span class="op">&lt;</span>EventReference<span class="op">&gt;</span> eventReferences <span class="op">=</span> <span class="fu">executeOptimizedQuery</span><span class="op">(</span>optimizedQuery<span class="op">);</span>  <span class="co">// ‚Üí Step 4.1b</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Load and deserialize events</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>                <span class="dt">final</span> <span class="bu">List</span><span class="op">&lt;</span>VersionedDomainEvent<span class="op">&gt;</span> events <span class="op">=</span> <span class="fu">loadEvents</span><span class="op">(</span>eventReferences<span class="op">);</span>  <span class="co">// ‚Üí Step 4.1c</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Apply additional filtering if needed</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="fu">applyAdditionalFiltering</span><span class="op">(</span>events<span class="op">,</span> query<span class="op">);</span>  <span class="co">// ‚Üí Step 4.1d</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="dt">final</span> <span class="bu">Exception</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>                <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">EventQueryException</span><span class="op">(</span><span class="st">&quot;Failed to execute event query&quot;</span><span class="op">,</span> e<span class="op">,</span> query<span class="op">);</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">});</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> OptimizedQuery <span class="fu">optimizeQuery</span><span class="op">(</span><span class="dt">final</span> EventQuery query<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> QueryOptimizer optimizer <span class="op">=</span> <span class="kw">new</span> <span class="fu">QueryOptimizer</span><span class="op">();</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Analyze query predicates</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>        optimizer<span class="op">.</span><span class="fu">analyzePredicates</span><span class="op">(</span>query<span class="op">.</span><span class="fu">getPredicates</span><span class="op">());</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Choose optimal index strategy</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> IndexStrategy indexStrategy <span class="op">=</span> optimizer<span class="op">.</span><span class="fu">chooseIndexStrategy</span><span class="op">(</span>query<span class="op">);</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Reorder predicates for optimal execution</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> <span class="bu">List</span><span class="op">&lt;</span>QueryPredicate<span class="op">&gt;</span> optimizedPredicates <span class="op">=</span> optimizer<span class="op">.</span><span class="fu">optimizePredicateOrder</span><span class="op">(</span>query<span class="op">.</span><span class="fu">getPredicates</span><span class="op">());</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Add index hints</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> <span class="bu">List</span><span class="op">&lt;</span>IndexHint<span class="op">&gt;</span> indexHints <span class="op">=</span> optimizer<span class="op">.</span><span class="fu">generateIndexHints</span><span class="op">(</span>query<span class="op">);</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">OptimizedQuery</span><span class="op">(</span>query<span class="op">,</span> indexStrategy<span class="op">,</span> optimizedPredicates<span class="op">,</span> indexHints<span class="op">);</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">List</span><span class="op">&lt;</span>EventReference<span class="op">&gt;</span> <span class="fu">executeOptimizedQuery</span><span class="op">(</span><span class="dt">final</span> OptimizedQuery optimizedQuery<span class="op">)</span> <span class="kw">throws</span> QueryException <span class="op">{</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> IndexStrategy strategy <span class="op">=</span> optimizedQuery<span class="op">.</span><span class="fu">getIndexStrategy</span><span class="op">();</span></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> <span class="op">(</span>strategy<span class="op">.</span><span class="fu">getPrimaryIndexType</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> TEMPORAL <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="fu">executeTemporalQuery</span><span class="op">(</span>optimizedQuery<span class="op">);</span>  <span class="co">// ‚Üí Step 4.1e</span></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> AGGREGATE <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="fu">executeAggregateQuery</span><span class="op">(</span>optimizedQuery<span class="op">);</span>  <span class="co">// ‚Üí Step 4.1f</span></span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> TYPE <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="fu">executeTypeQuery</span><span class="op">(</span>optimizedQuery<span class="op">);</span>  <span class="co">// ‚Üí Step 4.1g</span></span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> CAUSAL <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="fu">executeCausalQuery</span><span class="op">(</span>optimizedQuery<span class="op">);</span>  <span class="co">// ‚Üí Step 4.1h</span></span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> FULL_TEXT <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="fu">executeFullTextQuery</span><span class="op">(</span>optimizedQuery<span class="op">);</span>  <span class="co">// ‚Üí Step 4.1i</span></span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a>            <span class="kw">default</span> <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="fu">executeGenericQuery</span><span class="op">(</span>optimizedQuery<span class="op">);</span></span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">List</span><span class="op">&lt;</span>EventReference<span class="op">&gt;</span> <span class="fu">executeTemporalQuery</span><span class="op">(</span><span class="dt">final</span> OptimizedQuery query<span class="op">)</span> <span class="kw">throws</span> QueryException <span class="op">{</span></span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> TemporalIndex temporalIndex <span class="op">=</span> <span class="fu">getTemporalIndex</span><span class="op">();</span></span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> <span class="bu">List</span><span class="op">&lt;</span>EventReference<span class="op">&gt;</span> references <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;&gt;();</span></span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Extract time range from query</span></span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> TimeRange timeRange <span class="op">=</span> <span class="fu">extractTimeRange</span><span class="op">(</span>query<span class="op">);</span></span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>timeRange <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Use temporal index for efficient range query</span></span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a>            <span class="dt">final</span> <span class="bu">List</span><span class="op">&lt;</span>IndexEntry<span class="op">&gt;</span> indexEntries <span class="op">=</span> temporalIndex<span class="op">.</span><span class="fu">findInRange</span><span class="op">(</span></span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a>                timeRange<span class="op">.</span><span class="fu">getStart</span><span class="op">(),</span></span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a>                timeRange<span class="op">.</span><span class="fu">getEnd</span><span class="op">()</span></span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a>            <span class="op">);</span></span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Convert index entries to event references</span></span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="op">(</span><span class="dt">final</span> IndexEntry entry <span class="op">:</span> indexEntries<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true" tabindex="-1"></a>                references<span class="op">.</span><span class="fu">add</span><span class="op">(</span><span class="kw">new</span> <span class="fu">EventReference</span><span class="op">(</span></span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true" tabindex="-1"></a>                    entry<span class="op">.</span><span class="fu">getEventId</span><span class="op">(),</span></span>
<span id="cb10-86"><a href="#cb10-86" aria-hidden="true" tabindex="-1"></a>                    entry<span class="op">.</span><span class="fu">getFilePath</span><span class="op">(),</span></span>
<span id="cb10-87"><a href="#cb10-87" aria-hidden="true" tabindex="-1"></a>                    entry<span class="op">.</span><span class="fu">getEventType</span><span class="op">(),</span></span>
<span id="cb10-88"><a href="#cb10-88" aria-hidden="true" tabindex="-1"></a>                    entry<span class="op">.</span><span class="fu">getTimestamp</span><span class="op">()</span></span>
<span id="cb10-89"><a href="#cb10-89" aria-hidden="true" tabindex="-1"></a>                <span class="op">));</span></span>
<span id="cb10-90"><a href="#cb10-90" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb10-91"><a href="#cb10-91" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb10-92"><a href="#cb10-92" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Full scan if no time range specified</span></span>
<span id="cb10-93"><a href="#cb10-93" aria-hidden="true" tabindex="-1"></a>            references<span class="op">.</span><span class="fu">addAll</span><span class="op">(</span>temporalIndex<span class="op">.</span><span class="fu">getAllEntries</span><span class="op">());</span></span>
<span id="cb10-94"><a href="#cb10-94" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb10-95"><a href="#cb10-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-96"><a href="#cb10-96" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Apply additional temporal filters</span></span>
<span id="cb10-97"><a href="#cb10-97" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fu">applyTemporalFilters</span><span class="op">(</span>references<span class="op">,</span> query<span class="op">);</span></span>
<span id="cb10-98"><a href="#cb10-98" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-99"><a href="#cb10-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-100"><a href="#cb10-100" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">List</span><span class="op">&lt;</span>VersionedDomainEvent<span class="op">&gt;</span> <span class="fu">loadEvents</span><span class="op">(</span><span class="dt">final</span> <span class="bu">List</span><span class="op">&lt;</span>EventReference<span class="op">&gt;</span> eventReferences<span class="op">)</span> <span class="kw">throws</span> LoadException <span class="op">{</span></span>
<span id="cb10-101"><a href="#cb10-101" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> <span class="bu">List</span><span class="op">&lt;</span>VersionedDomainEvent<span class="op">&gt;</span> events <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;&gt;();</span></span>
<span id="cb10-102"><a href="#cb10-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-103"><a href="#cb10-103" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Group references by storage location for efficient loading</span></span>
<span id="cb10-104"><a href="#cb10-104" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> <span class="bu">Map</span><span class="op">&lt;</span>Path<span class="op">,</span> <span class="bu">List</span><span class="op">&lt;</span>EventReference<span class="op">&gt;&gt;</span> groupedReferences <span class="op">=</span> </span>
<span id="cb10-105"><a href="#cb10-105" aria-hidden="true" tabindex="-1"></a>            eventReferences<span class="op">.</span><span class="fu">stream</span><span class="op">().</span><span class="fu">collect</span><span class="op">(</span>Collectors<span class="op">.</span><span class="fu">groupingBy</span><span class="op">(</span>EventReference<span class="op">::</span>getDirectoryPath<span class="op">));</span></span>
<span id="cb10-106"><a href="#cb10-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-107"><a href="#cb10-107" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Load events in batches by directory</span></span>
<span id="cb10-108"><a href="#cb10-108" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">final</span> <span class="bu">Map</span><span class="op">.</span><span class="fu">Entry</span><span class="op">&lt;</span>Path<span class="op">,</span> <span class="bu">List</span><span class="op">&lt;</span>EventReference<span class="op">&gt;&gt;</span> entry <span class="op">:</span> groupedReferences<span class="op">.</span><span class="fu">entrySet</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb10-109"><a href="#cb10-109" aria-hidden="true" tabindex="-1"></a>            <span class="dt">final</span> <span class="bu">List</span><span class="op">&lt;</span>VersionedDomainEvent<span class="op">&gt;</span> directoryEvents <span class="op">=</span> <span class="fu">loadEventsFromDirectory</span><span class="op">(</span></span>
<span id="cb10-110"><a href="#cb10-110" aria-hidden="true" tabindex="-1"></a>                entry<span class="op">.</span><span class="fu">getKey</span><span class="op">(),</span></span>
<span id="cb10-111"><a href="#cb10-111" aria-hidden="true" tabindex="-1"></a>                entry<span class="op">.</span><span class="fu">getValue</span><span class="op">()</span></span>
<span id="cb10-112"><a href="#cb10-112" aria-hidden="true" tabindex="-1"></a>            <span class="op">);</span></span>
<span id="cb10-113"><a href="#cb10-113" aria-hidden="true" tabindex="-1"></a>            events<span class="op">.</span><span class="fu">addAll</span><span class="op">(</span>directoryEvents<span class="op">);</span></span>
<span id="cb10-114"><a href="#cb10-114" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb10-115"><a href="#cb10-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-116"><a href="#cb10-116" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Sort events by timestamp to maintain temporal order</span></span>
<span id="cb10-117"><a href="#cb10-117" aria-hidden="true" tabindex="-1"></a>        events<span class="op">.</span><span class="fu">sort</span><span class="op">(</span><span class="bu">Comparator</span><span class="op">.</span><span class="fu">comparing</span><span class="op">(</span>VersionedDomainEvent<span class="op">::</span>getTimestamp<span class="op">));</span></span>
<span id="cb10-118"><a href="#cb10-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-119"><a href="#cb10-119" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> events<span class="op">;</span></span>
<span id="cb10-120"><a href="#cb10-120" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-121"><a href="#cb10-121" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong><strong>Runtime Behavior</strong></strong>: The query engine
provides sophisticated optimization and execution capabilities that
enable fast retrieval across large event datasets using multiple
indexing strategies.</p>
<h2 id="step-4.2-event-replay-and-system-reconstruction">Step 4.2: Event
Replay and System Reconstruction</h2>
<div class="sourceCode" id="cb11"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">// From: EventReplayEngine.java (Domain Service)</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> EventReplayEngine <span class="op">{</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> ReplayResult <span class="fu">replayEventsFromTimePoint</span><span class="op">(</span><span class="dt">final</span> Instant fromTime<span class="op">,</span> </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>                                                 <span class="dt">final</span> Instant toTime<span class="op">,</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>                                                 <span class="dt">final</span> ReplayConfiguration config<span class="op">)</span> <span class="kw">throws</span> ReplayException <span class="op">{</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Query events in the specified time range</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>            <span class="dt">final</span> EventQuery query <span class="op">=</span> EventQuery<span class="op">.</span><span class="fu">builder</span><span class="op">()</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">timeRange</span><span class="op">(</span>fromTime<span class="op">,</span> toTime<span class="op">)</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">includeSnapshots</span><span class="op">(</span>config<span class="op">.</span><span class="fu">isIncludeSnapshots</span><span class="op">())</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">orderBy</span><span class="op">(</span>EventOrder<span class="op">.</span><span class="fu">TEMPORAL_ASCENDING</span><span class="op">)</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>            <span class="dt">final</span> <span class="bu">List</span><span class="op">&lt;</span>VersionedDomainEvent<span class="op">&gt;</span> events <span class="op">=</span> eventQueryEngine<span class="op">.</span><span class="fu">executeQuery</span><span class="op">(</span>query<span class="op">).</span><span class="fu">get</span><span class="op">();</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Create replay context</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>            <span class="dt">final</span> ReplayContext replayContext <span class="op">=</span> <span class="fu">createReplayContext</span><span class="op">(</span>fromTime<span class="op">,</span> config<span class="op">);</span>  <span class="co">// ‚Üí Step 4.2a</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Execute replay sequence</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>            <span class="dt">final</span> ReplayResult result <span class="op">=</span> <span class="fu">executeReplay</span><span class="op">(</span>events<span class="op">,</span> replayContext<span class="op">);</span>  <span class="co">// ‚Üí Step 4.2b</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Validate replay integrity</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>            <span class="fu">validateReplayResult</span><span class="op">(</span>result<span class="op">,</span> config<span class="op">);</span>  <span class="co">// ‚Üí Step 4.2c</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="dt">final</span> <span class="bu">Exception</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">ReplayException</span><span class="op">(</span><span class="st">&quot;Failed to replay events&quot;</span><span class="op">,</span> e<span class="op">,</span> fromTime<span class="op">,</span> toTime<span class="op">);</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> ReplayContext <span class="fu">createReplayContext</span><span class="op">(</span><span class="dt">final</span> Instant fromTime<span class="op">,</span> </span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>                                             <span class="dt">final</span> ReplayConfiguration config<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Find the closest system snapshot before the replay start time</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> SystemStateSnapshot baselineSnapshot <span class="op">=</span> <span class="fu">findBaselineSnapshot</span><span class="op">(</span>fromTime<span class="op">);</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Create isolated replay environment</span></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> ReplayEnvironment environment <span class="op">=</span> <span class="kw">new</span> <span class="fu">ReplayEnvironment</span><span class="op">(</span></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>            baselineSnapshot<span class="op">,</span></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>            config<span class="op">.</span><span class="fu">getIsolationLevel</span><span class="op">(),</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>            config<span class="op">.</span><span class="fu">getReplaySpeed</span><span class="op">()</span></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Initialize replay tracking</span></span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> ReplayTracker tracker <span class="op">=</span> <span class="kw">new</span> <span class="fu">ReplayTracker</span><span class="op">(</span>fromTime<span class="op">,</span> config<span class="op">);</span></span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">ReplayContext</span><span class="op">(</span>environment<span class="op">,</span> tracker<span class="op">,</span> config<span class="op">);</span></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> ReplayResult <span class="fu">executeReplay</span><span class="op">(</span><span class="dt">final</span> <span class="bu">List</span><span class="op">&lt;</span>VersionedDomainEvent<span class="op">&gt;</span> events<span class="op">,</span> </span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>                                      <span class="dt">final</span> ReplayContext context<span class="op">)</span> <span class="kw">throws</span> ReplayException <span class="op">{</span></span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> ReplayResultBuilder resultBuilder <span class="op">=</span> <span class="kw">new</span> <span class="fu">ReplayResultBuilder</span><span class="op">(</span>context<span class="op">);</span></span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Initialize replay state</span></span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>            <span class="fu">initializeReplayState</span><span class="op">(</span>context<span class="op">);</span></span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Process events in sequence</span></span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="op">(</span><span class="dt">final</span> VersionedDomainEvent event <span class="op">:</span> events<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>                <span class="dt">final</span> ReplayEventResult eventResult <span class="op">=</span> <span class="fu">replayEvent</span><span class="op">(</span>event<span class="op">,</span> context<span class="op">);</span>  <span class="co">// ‚Üí Step 4.2d</span></span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>                resultBuilder<span class="op">.</span><span class="fu">addEventResult</span><span class="op">(</span>eventResult<span class="op">);</span></span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Update replay state</span></span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a>                <span class="fu">updateReplayState</span><span class="op">(</span>context<span class="op">,</span> event<span class="op">,</span> eventResult<span class="op">);</span></span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Check for replay termination conditions</span></span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span><span class="fu">shouldTerminateReplay</span><span class="op">(</span>context<span class="op">,</span> eventResult<span class="op">))</span> <span class="op">{</span></span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a>                    resultBuilder<span class="op">.</span><span class="fu">setTerminationReason</span><span class="op">(</span><span class="st">&quot;Replay terminated due to error or condition&quot;</span><span class="op">);</span></span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span><span class="op">;</span></span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Apply replay speed control</span></span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a>                <span class="fu">applyReplaySpeedControl</span><span class="op">(</span>context<span class="op">);</span></span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Finalize replay state</span></span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a>            <span class="fu">finalizeReplayState</span><span class="op">(</span>context<span class="op">);</span></span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> resultBuilder<span class="op">.</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="dt">final</span> <span class="bu">Exception</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Clean up replay state on failure</span></span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a>            <span class="fu">cleanupReplayState</span><span class="op">(</span>context<span class="op">);</span></span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a>            <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">ReplayException</span><span class="op">(</span><span class="st">&quot;Event replay execution failed&quot;</span><span class="op">,</span> e<span class="op">);</span></span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> ReplayEventResult <span class="fu">replayEvent</span><span class="op">(</span><span class="dt">final</span> VersionedDomainEvent event<span class="op">,</span> </span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a>                                         <span class="dt">final</span> ReplayContext context<span class="op">)</span> <span class="kw">throws</span> ReplayEventException <span class="op">{</span></span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> Instant replayStartTime <span class="op">=</span> Instant<span class="op">.</span><span class="fu">now</span><span class="op">();</span></span>
<span id="cb11-92"><a href="#cb11-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-93"><a href="#cb11-93" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb11-94"><a href="#cb11-94" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Recreate event context for replay</span></span>
<span id="cb11-95"><a href="#cb11-95" aria-hidden="true" tabindex="-1"></a>            <span class="dt">final</span> <span class="bu">EventContext</span> recreatedContext <span class="op">=</span> <span class="fu">recreateEventContext</span><span class="op">(</span>event<span class="op">,</span> context<span class="op">);</span></span>
<span id="cb11-96"><a href="#cb11-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-97"><a href="#cb11-97" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Execute event replay based on event type</span></span>
<span id="cb11-98"><a href="#cb11-98" aria-hidden="true" tabindex="-1"></a>            <span class="dt">final</span> <span class="bu">Object</span> replayResult <span class="op">=</span> <span class="fu">executeEventReplay</span><span class="op">(</span>event<span class="op">,</span> recreatedContext<span class="op">);</span>  <span class="co">// ‚Üí Step 4.2e</span></span>
<span id="cb11-99"><a href="#cb11-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-100"><a href="#cb11-100" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Capture replay metrics</span></span>
<span id="cb11-101"><a href="#cb11-101" aria-hidden="true" tabindex="-1"></a>            <span class="dt">final</span> <span class="bu">Duration</span> replayDuration <span class="op">=</span> <span class="bu">Duration</span><span class="op">.</span><span class="fu">between</span><span class="op">(</span>replayStartTime<span class="op">,</span> Instant<span class="op">.</span><span class="fu">now</span><span class="op">());</span></span>
<span id="cb11-102"><a href="#cb11-102" aria-hidden="true" tabindex="-1"></a>            <span class="dt">final</span> ReplayMetrics metrics <span class="op">=</span> <span class="kw">new</span> <span class="fu">ReplayMetrics</span><span class="op">(</span>replayDuration<span class="op">,</span> recreatedContext<span class="op">);</span></span>
<span id="cb11-103"><a href="#cb11-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-104"><a href="#cb11-104" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> ReplayEventResult<span class="op">.</span><span class="fu">success</span><span class="op">(</span>event<span class="op">,</span> replayResult<span class="op">,</span> metrics<span class="op">);</span></span>
<span id="cb11-105"><a href="#cb11-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-106"><a href="#cb11-106" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="dt">final</span> <span class="bu">Exception</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-107"><a href="#cb11-107" aria-hidden="true" tabindex="-1"></a>            <span class="dt">final</span> <span class="bu">Duration</span> replayDuration <span class="op">=</span> <span class="bu">Duration</span><span class="op">.</span><span class="fu">between</span><span class="op">(</span>replayStartTime<span class="op">,</span> Instant<span class="op">.</span><span class="fu">now</span><span class="op">());</span></span>
<span id="cb11-108"><a href="#cb11-108" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> ReplayEventResult<span class="op">.</span><span class="fu">failure</span><span class="op">(</span>event<span class="op">,</span> e<span class="op">,</span> replayDuration<span class="op">);</span></span>
<span id="cb11-109"><a href="#cb11-109" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb11-110"><a href="#cb11-110" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-111"><a href="#cb11-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-112"><a href="#cb11-112" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Object</span> <span class="fu">executeEventReplay</span><span class="op">(</span><span class="dt">final</span> VersionedDomainEvent event<span class="op">,</span> </span>
<span id="cb11-113"><a href="#cb11-113" aria-hidden="true" tabindex="-1"></a>                                     <span class="dt">final</span> <span class="bu">EventContext</span> context<span class="op">)</span> <span class="kw">throws</span> ReplayEventException <span class="op">{</span></span>
<span id="cb11-114"><a href="#cb11-114" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Route event to appropriate replay handler based on type</span></span>
<span id="cb11-115"><a href="#cb11-115" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>event <span class="kw">instanceof</span> ClassFileChanged classFileEvent<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-116"><a href="#cb11-116" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fu">replayClassFileChanged</span><span class="op">(</span>classFileEvent<span class="op">,</span> context<span class="op">);</span></span>
<span id="cb11-117"><a href="#cb11-117" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>event <span class="kw">instanceof</span> BytecodeValidated validationEvent<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-118"><a href="#cb11-118" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fu">replayBytecodeValidated</span><span class="op">(</span>validationEvent<span class="op">,</span> context<span class="op">);</span></span>
<span id="cb11-119"><a href="#cb11-119" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>event <span class="kw">instanceof</span> HotSwapRequested hotSwapEvent<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-120"><a href="#cb11-120" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fu">replayHotSwapRequested</span><span class="op">(</span>hotSwapEvent<span class="op">,</span> context<span class="op">);</span></span>
<span id="cb11-121"><a href="#cb11-121" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>event <span class="kw">instanceof</span> ClassRedefinitionSucceeded successEvent<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-122"><a href="#cb11-122" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fu">replayClassRedefinitionSucceeded</span><span class="op">(</span>successEvent<span class="op">,</span> context<span class="op">);</span></span>
<span id="cb11-123"><a href="#cb11-123" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>event <span class="kw">instanceof</span> ClassRedefinitionFailed failureEvent<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-124"><a href="#cb11-124" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fu">replayClassRedefinitionFailed</span><span class="op">(</span>failureEvent<span class="op">,</span> context<span class="op">);</span></span>
<span id="cb11-125"><a href="#cb11-125" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb11-126"><a href="#cb11-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-127"><a href="#cb11-127" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Generic replay for unknown event types</span></span>
<span id="cb11-128"><a href="#cb11-128" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fu">replayGenericEvent</span><span class="op">(</span>event<span class="op">,</span> context<span class="op">);</span></span>
<span id="cb11-129"><a href="#cb11-129" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-130"><a href="#cb11-130" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong><strong>Runtime Behavior</strong></strong>: Event replay
provides sophisticated system reconstruction capabilities that enable
precise debugging, testing, and analysis of historical system states and
behaviors.</p>
<h1 id="cross-cutting-persistence-patterns">Cross-Cutting Persistence
Patterns</h1>
<h2 id="event-sourcing-consistency">Event Sourcing Consistency</h2>
<p>All events maintain strict consistency guarantees:</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Pattern for event sourcing consistency</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">ensureEventConsistency</span><span class="op">(</span>VersionedDomainEvent event<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Atomic write operations</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Version conflict detection</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Aggregate consistency validation</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Causal ordering preservation</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="storage-partitioning-strategy">Storage Partitioning
Strategy</h2>
<p>Events are intelligently partitioned for optimal access:</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Pattern for storage partitioning</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> StoragePartition <span class="fu">determinePartition</span><span class="op">(</span><span class="bu">Event</span> event<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Hot: Recent, frequently accessed events</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Warm: Moderately recent events  </span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Cold: Archival events</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Critical: High-availability events</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="index-maintenance-optimization">Index Maintenance
Optimization</h2>
<p>Indices are maintained efficiently as events are stored:</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Pattern for index maintenance</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">maintainIndices</span><span class="op">(</span><span class="bu">Event</span> event<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Batch index updates</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Background index optimization</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Index compaction strategies</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Query performance monitoring</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h1 id="system-intelligence-through-event-analysis">System Intelligence
Through Event Analysis</h1>
<h2 id="pattern-recognition">Pattern Recognition</h2>
<p>The event store enables sophisticated pattern recognition:</p>
<ul>
<li>Developer workflow patterns</li>
<li>System performance patterns</li>
<li>Error and failure patterns</li>
<li>Usage and adoption patterns</li>
</ul>
<h2 id="predictive-analysis">Predictive Analysis</h2>
<p>Historical events enable predictive capabilities:</p>
<ul>
<li>Failure prediction based on patterns</li>
<li>Performance optimization opportunities</li>
<li>User behavior prediction</li>
<li>System capacity planning</li>
</ul>
<h2 id="audit-and-compliance">Audit and Compliance</h2>
<p>Complete event capture provides comprehensive audit trails:</p>
<ul>
<li>Who performed what actions when</li>
<li>What changes were made and why</li>
<li>How the system responded to changes</li>
<li>What the impact of changes was</li>
</ul>
<h1 id="conclusion-building-system-memory-and-intelligence">Conclusion:
Building System Memory and Intelligence</h1>
<p>ByteHot's Event Sourcing Persistence Flow demonstrates how
sophisticated event capture and storage can create a system with
complete memory and intelligence. By treating every significant action
as an immutable event, ByteHot builds comprehensive understanding of
system behavior over time, enabling debugging, analysis, optimization,
and learning that would be impossible with traditional logging
approaches.</p>
<p>This flow shows how event sourcing principles can be implemented with
clean architecture, sophisticated indexing, and powerful query
capabilities to create a system that not only records history but learns
from it to become more effective over time.</p>
<h2 id="related-flow-documentation">Related Flow Documentation</h2>
<ul>
<li><span class="spurious-link"
target="complete-hot-swap-flow.org"><em>Complete Hot-Swap
Flow</em></span>: Events generated and captured by this flow</li>
<li><span class="spurious-link"
target="agent-startup-initialization-flow.org"><em>Agent Startup
Flow</em></span>: Event sourcing infrastructure initialization</li>
<li><span class="spurious-link"
target="flow-intelligence-learning-flow.org"><em>Flow Intelligence
Learning</em></span>: Analysis of captured events</li>
</ul>
<h2 id="next-steps-for-event-sourcing-evolution">Next Steps for Event
Sourcing Evolution</h2>
<ol>
<li><strong><strong>Distributed Event Sourcing</strong></strong>:
Support for multi-node event capture and storage</li>
<li><strong><strong>Stream Processing Integration</strong></strong>:
Real-time event stream analysis</li>
<li><strong><strong>Machine Learning Integration</strong></strong>:
Advanced pattern recognition and prediction</li>
<li><strong><strong>Cloud Storage Integration</strong></strong>:
Scalable cloud-based event storage and analysis</li>
</ol>
        </div>
    </div>

        </div>
    </div>

    <footer class="footer">
        <p>&copy; 2025 ByteHot Project. Licensed under <a href="https://www.gnu.org/licenses/gpl-3.0.html">GPLv3</a></p>
        <p>
            <a href="https://github.com/rydnr/bytehot">GitHub</a> ‚Ä¢ 
            <a href="https://github.com/rydnr/bytehot/issues">Issues</a> ‚Ä¢ 
            <a href="https://github.com/rydnr/bytehot/discussions">Discussions</a>
        </p>
    </footer>

    <script>
        // Matrix rain effect (lighter for documentation pages)
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        document.querySelector('.matrix-bg').appendChild(canvas);

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const matrix = "BYTEHOT0123456789";
        const drops = [];

        for(let x = 0; x < canvas.width / 15; x++) {
            drops[x] = 1;
        }

        function draw() {
            ctx.fillStyle = 'rgba(15, 15, 35, 0.05)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = '#00ff00';
            ctx.font = '12px Courier New';

            for(let i = 0; i < drops.length; i++) {
                const text = matrix[Math.floor(Math.random() * matrix.length)];
                ctx.fillText(text, i * 15, drops[i] * 15);

                if(drops[i] * 15 > canvas.height && Math.random() > 0.98) {
                    drops[i] = 0;
                }
                drops[i]++;
            }
        }

        setInterval(draw, 50);

        // Resize canvas on window resize
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });
    </script>
</body>
</html>
