<!DOCTYPE html>
<html>
<head>
    <title>JvmInstrumentationService - ByteHot Documentation</title>
    <link rel="stylesheet" href="../style.css">
</head>
<body>
<div class="navigation">
    <a href="../index.html">üè† Home</a>
    <a href="../implementation.html">üèóÔ∏è Implementation</a>
    <a href="../journal.html">üìî Journal</a>
    <a href="../docs/">üìö Docs</a>
    <a href="../javadocs/">üìñ Javadocs</a>
    <a href="https://github.com/rydnr/bytehot">üîó GitHub</a>
</div>
<main>
<h1 id="jvminstrumentationservice">JvmInstrumentationService</h1>
<h2 id="overview">Overview</h2>
<p>The <code class="verbatim">JvmInstrumentationService</code> class
provides a concrete implementation of the <code
class="verbatim">InstrumentationService</code> interface, serving as the
primary bridge between ByteHot's domain layer and the JVM's native
instrumentation capabilities. This class wraps the standard <code
class="verbatim">java.lang.instrument.Instrumentation</code> API to
provide domain-specific instrumentation services with proper error
handling and domain event integration.</p>
<h2 id="architecture-role">Architecture Role</h2>
<h3 id="domain-service-implementation">Domain Service
Implementation</h3>
<p>The <code class="verbatim">JvmInstrumentationService</code>
implements the Domain Service pattern:</p>
<ul>
<li>Provides concrete implementation of <code
class="verbatim">InstrumentationService</code> interface</li>
<li>Encapsulates JVM-specific instrumentation logic</li>
<li>Maintains domain boundaries while accessing infrastructure
capabilities</li>
<li>Translates infrastructure exceptions to domain-specific
exceptions</li>
</ul>
<h3 id="adapter-pattern-implementation">Adapter Pattern
Implementation</h3>
<p>While residing in the domain layer, this class acts as an
adapter:</p>
<ul>
<li>Adapts JVM <code class="verbatim">Instrumentation</code> API to
domain service interface</li>
<li>Provides domain-friendly method signatures and error handling</li>
<li>Translates between infrastructure and domain exception models</li>
<li>Maintains clean separation between domain logic and JVM
specifics</li>
</ul>
<h2 id="core-implementation">Core Implementation</h2>
<h3 id="constructor-and-initialization">Constructor and
Initialization</h3>
<div class="sourceCode" id="cb1"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="fu">JvmInstrumentationService</span><span class="op">(</span><span class="dt">final</span> <span class="bu">Instrumentation</span> instrumentation<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>instrumentation <span class="op">==</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">IllegalArgumentException</span><span class="op">(</span><span class="st">&quot;Instrumentation cannot be null&quot;</span><span class="op">);</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">instrumentation</span> <span class="op">=</span> instrumentation<span class="op">;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The constructor ensures robust initialization:</p>
<ul>
<li><strong><strong>Null Check</strong></strong>: Validates
instrumentation instance is provided</li>
<li><strong><strong>Fail-Fast</strong></strong>: Throws meaningful
exception for invalid parameters</li>
<li><strong><strong>Immutable State</strong></strong>: Stores
instrumentation reference as final field</li>
<li><strong><strong>Domain Contracts</strong></strong>: Maintains domain
service reliability expectations</li>
</ul>
<h3 id="capability-detection-methods">Capability Detection Methods</h3>
<ol>
<li><p>Class Redefinition Support</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Override</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">boolean</span> <span class="fu">isRedefineClassesSupported</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> instrumentation<span class="op">.</span><span class="fu">isRedefineClassesSupported</span><span class="op">();</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Direct delegation to JVM capability detection:</p>
<ul>
<li><strong><strong>JVM Query</strong></strong>: Checks native JVM
redefinition support</li>
<li><strong><strong>Hot-Swap Foundation</strong></strong>: Fundamental
capability for hot-swapping</li>
<li><strong><strong>Runtime Detection</strong></strong>: Determines
capability at runtime for robustness</li>
<li><strong><strong>Boolean Contract</strong></strong>: Simple
true/false response for domain logic</li>
</ul></li>
<li><p>Class Retransformation Support</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Override</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">boolean</span> <span class="fu">isRetransformClassesSupported</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> instrumentation<span class="op">.</span><span class="fu">isRetransformClassesSupported</span><span class="op">();</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Advanced capability detection for retransformation:</p>
<ul>
<li><strong><strong>Advanced Feature</strong></strong>: Checks for more
sophisticated transformation support</li>
<li><strong><strong>Future Enhancement</strong></strong>: Enables
advanced transformation scenarios</li>
<li><strong><strong>Capability Awareness</strong></strong>: Allows
domain logic to adapt based on JVM capabilities</li>
<li><strong><strong>Compatibility Check</strong></strong>: Ensures code
works across different JVM versions</li>
</ul>
<p>### Class Redefinition Operations</p>
<p>#### Multiple Class Redefinition</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Override</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">redefineClasses</span><span class="op">(</span><span class="dt">final</span> <span class="bu">ClassDefinition</span><span class="kw">...</span> definitions<span class="op">)</span> <span class="kw">throws</span> HotSwapException <span class="op">{</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>        instrumentation<span class="op">.</span><span class="fu">redefineClasses</span><span class="op">(</span>definitions<span class="op">);</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="dt">final</span> <span class="bu">ClassNotFoundException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">throw</span> <span class="fu">createHotSwapException</span><span class="op">(</span><span class="st">&quot;Class not found during redefinition&quot;</span><span class="op">,</span> e<span class="op">);</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="dt">final</span> <span class="bu">UnmodifiableClassException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">throw</span> <span class="fu">createHotSwapException</span><span class="op">(</span><span class="st">&quot;Class is not modifiable&quot;</span><span class="op">,</span> e<span class="op">);</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="dt">final</span> <span class="bu">UnsupportedOperationException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">throw</span> <span class="fu">createHotSwapException</span><span class="op">(</span><span class="st">&quot;Redefinition not supported&quot;</span><span class="op">,</span> e<span class="op">);</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="dt">final</span> <span class="bu">Exception</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">throw</span> <span class="fu">createHotSwapException</span><span class="op">(</span><span class="st">&quot;Unexpected error during class redefinition&quot;</span><span class="op">,</span> e<span class="op">);</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Comprehensive error handling for batch class redefinition:</p>
<ul>
<li><strong><strong>Batch Operation</strong></strong>: Supports multiple
class redefinitions atomically</li>
<li><strong><strong>Exception Translation</strong></strong>: Converts
JVM exceptions to domain exceptions</li>
<li><strong><strong>Specific Error Handling</strong></strong>: Different
handling for different failure types</li>
<li><strong><strong>Domain Event Integration</strong></strong>: Creates
appropriate domain events for failures</li>
</ul>
<p>#### Single Class Redefinition</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Override</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">redefineClass</span><span class="op">(</span><span class="dt">final</span> <span class="bu">Class</span><span class="op">&lt;?&gt;</span> targetClass<span class="op">,</span> <span class="dt">final</span> <span class="dt">byte</span><span class="op">[]</span> newBytecode<span class="op">)</span> <span class="kw">throws</span> HotSwapException <span class="op">{</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">final</span> <span class="bu">ClassDefinition</span> definition <span class="op">=</span> <span class="kw">new</span> <span class="bu">ClassDefinition</span><span class="op">(</span>targetClass<span class="op">,</span> newBytecode<span class="op">);</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">redefineClasses</span><span class="op">(</span>definition<span class="op">);</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Convenience method for single class redefinition:</p>
<ul>
<li><strong><strong>Single Class Focus</strong></strong>: Simplifies
common single-class redefinition scenarios</li>
<li><strong><strong>Bytecode Integration</strong></strong>: Direct
integration with bytecode arrays</li>
<li><strong><strong>Delegation Pattern</strong></strong>: Leverages
batch operation for consistency</li>
<li><strong><strong>API Simplification</strong></strong>: Provides
simpler interface for common use cases</li>
</ul>
<p>### Class Discovery and Analysis</p>
<p>#### Loaded Class Enumeration</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Override</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="bu">Class</span><span class="op">&lt;?&gt;[]</span> <span class="fu">getAllLoadedClasses</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> instrumentation<span class="op">.</span><span class="fu">getAllLoadedClasses</span><span class="op">();</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Direct access to all loaded classes:</p>
<ul>
<li><strong><strong>Complete Enumeration</strong></strong>: Returns all
classes currently loaded in JVM</li>
<li><strong><strong>Hot-Swap Planning</strong></strong>: Enables
analysis of redefinition candidates</li>
<li><strong><strong>System State</strong></strong>: Provides insight
into current JVM class loading state</li>
<li><strong><strong>Direct Delegation</strong></strong>: Leverages JVM's
native class tracking</li>
</ul>
<p>#### Class Modifiability Check</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Override</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">boolean</span> <span class="fu">isModifiableClass</span><span class="op">(</span><span class="dt">final</span> <span class="bu">Class</span><span class="op">&lt;?&gt;</span> theClass<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> instrumentation<span class="op">.</span><span class="fu">isModifiableClass</span><span class="op">(</span>theClass<span class="op">);</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Checks whether specific classes can be modified:</p>
<ul>
<li><strong><strong>Pre-validation</strong></strong>: Enables validation
before attempting redefinition</li>
<li><strong><strong>Class-Specific</strong></strong>: Provides
class-level modification capability detection</li>
<li><strong><strong>Safety Check</strong></strong>: Prevents attempts to
modify unmodifiable classes</li>
<li><strong><strong>JVM Integration</strong></strong>: Uses JVM's native
modifiability detection</li>
</ul>
<p>#### Class Lookup by Name</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Override</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="bu">Class</span><span class="op">&lt;?&gt;</span> <span class="fu">findLoadedClass</span><span class="op">(</span><span class="dt">final</span> <span class="bu">String</span> className<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">final</span> <span class="bu">Class</span><span class="op">&lt;?&gt;[]</span> loadedClasses <span class="op">=</span> instrumentation<span class="op">.</span><span class="fu">getAllLoadedClasses</span><span class="op">();</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">final</span> <span class="bu">Class</span><span class="op">&lt;?&gt;</span> clazz <span class="op">:</span> loadedClasses<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>clazz<span class="op">.</span><span class="fu">getName</span><span class="op">().</span><span class="fu">equals</span><span class="op">(</span>className<span class="op">))</span> <span class="op">{</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> clazz<span class="op">;</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Finds loaded classes by name:</p>
<ul>
<li><strong><strong>Name-Based Lookup</strong></strong>: Enables class
discovery by string name</li>
<li><strong><strong>Linear Search</strong></strong>: Simple but reliable
implementation for class finding</li>
<li><strong><strong>Null Return</strong></strong>: Returns null when
class not found (following Java conventions)</li>
<li><strong><strong>Hot-Swap Support</strong></strong>: Enables finding
classes for redefinition by name</li>
</ul>
<p>### Error Handling and Domain Integration</p>
<p>#### Domain Exception Creation</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">protected</span> HotSwapException <span class="fu">createHotSwapException</span><span class="op">(</span><span class="dt">final</span> <span class="bu">String</span> reason<span class="op">,</span> <span class="dt">final</span> <span class="bu">Throwable</span> cause<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">final</span> ClassRedefinitionFailed failureEvent <span class="op">=</span> </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>        <span class="kw">new</span> <span class="fu">ClassRedefinitionFailed</span><span class="op">(</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;Unknown&quot;</span><span class="op">,</span> <span class="co">// className - would need to be passed in</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>            <span class="kw">null</span><span class="op">,</span>      <span class="co">// classFile - would need to be passed in</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>            reason<span class="op">,</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>            cause<span class="op">.</span><span class="fu">getMessage</span><span class="op">(),</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;Check bytecode compatibility and retry&quot;</span><span class="op">,</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>            java<span class="op">.</span><span class="fu">time</span><span class="op">.</span><span class="fu">Instant</span><span class="op">.</span><span class="fu">now</span><span class="op">()</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">new</span> <span class="fu">HotSwapException</span><span class="op">(</span>failureEvent<span class="op">,</span> cause<span class="op">);</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Creates domain-specific exceptions with event integration:</p>
<ul>
<li><strong><strong>Domain Event Creation</strong></strong>: Creates
<code class="verbatim">ClassRedefinitionFailed</code> events for
failures</li>
<li><strong><strong>Rich Context</strong></strong>: Provides detailed
failure information</li>
<li><strong><strong>Troubleshooting Guidance</strong></strong>: Includes
recommended recovery actions</li>
<li><strong><strong>Timestamp Integration</strong></strong>: Records
failure time for debugging and analysis</li>
<li><strong><strong>Cause Preservation</strong></strong>: Maintains
original exception chain for debugging</li>
</ul>
<p>## Integration with Domain Architecture</p>
<p>### Service Interface Compliance The <code
class="verbatim">JvmInstrumentationService</code> fully implements the
<code class="verbatim">InstrumentationService</code> interface:</p>
<ul>
<li><strong><strong>Complete Implementation</strong></strong>:
Implements all interface methods</li>
<li><strong><strong>Contract Compliance</strong></strong>: Adheres to
interface contracts and expectations</li>
<li><strong><strong>Behavioral Consistency</strong></strong>: Provides
predictable behavior across all operations</li>
<li><strong><strong>Exception Specifications</strong></strong>: Follows
interface exception specifications</li>
</ul>
<p>### Domain Event Integration The service integrates with ByteHot's
event-driven architecture:</p>
<ul>
<li><strong><strong>Failure Events</strong></strong>: Creates <code
class="verbatim">ClassRedefinitionFailed</code> events for failures</li>
<li><strong><strong>Event Sourcing</strong></strong>: Supports
event-driven error tracking and analysis</li>
<li><strong><strong>Domain Consistency</strong></strong>: Maintains
consistency with domain event patterns</li>
<li><strong><strong>Debugging Support</strong></strong>: Provides rich
event context for troubleshooting</li>
</ul>
<p>### Hot-Swap Manager Integration The service serves as the primary
instrumentation provider for <code
class="verbatim">HotSwapManager</code>:</p>
<ul>
<li><strong><strong>Capability Queries</strong></strong>: Provides
capability information for operation planning</li>
<li><strong><strong>Class Redefinition</strong></strong>: Performs
actual bytecode redefinition operations</li>
<li><strong><strong>Error Reporting</strong></strong>: Reports failures
through domain-appropriate mechanisms</li>
<li><strong><strong>State Queries</strong></strong>: Provides
information about loaded classes and their state</li>
</ul>
<p>## Design Principles</p>
<p>### Encapsulation of JVM Complexity The service encapsulates JVM
instrumentation complexity:</p>
<ul>
<li><strong><strong>API Simplification</strong></strong>: Provides
domain-appropriate interface over JVM APIs</li>
<li><strong><strong>Error Translation</strong></strong>: Converts JVM
exceptions to domain exceptions</li>
<li><strong><strong>Capability Abstraction</strong></strong>: Abstracts
JVM capability detection</li>
<li><strong><strong>State Management</strong></strong>: Manages JVM
state queries in domain-friendly way</li>
</ul>
<p>### Fail-Fast Design The service implements fail-fast principles:</p>
<ul>
<li><strong><strong>Constructor Validation</strong></strong>: Validates
dependencies at construction time</li>
<li><strong><strong>Immediate Feedback</strong></strong>: Provides
immediate feedback for invalid operations</li>
<li><strong><strong>Clear Exceptions</strong></strong>: Throws
meaningful exceptions for error conditions</li>
<li><strong><strong>Defensive Programming</strong></strong>: Validates
inputs and state consistently</li>
</ul>
<p>### Domain Boundary Maintenance Despite JVM integration, the service
maintains domain boundaries:</p>
<ul>
<li><strong><strong>Domain Exceptions</strong></strong>: Uses
domain-specific exception types</li>
<li><strong><strong>Domain Events</strong></strong>: Creates domain
events for significant operations</li>
<li><strong><strong>Domain Interface</strong></strong>: Implements
domain service interface</li>
<li><strong><strong>Clean Abstractions</strong></strong>: Provides clean
abstractions over infrastructure</li>
</ul>
<p>## Error Scenarios and Handling</p>
<p>### Class Not Found Errors When attempting to redefine non-existent
classes:</p>
<ul>
<li><strong><strong>Detection</strong></strong>: Catches <code
class="verbatim">ClassNotFoundException</code> from JVM</li>
<li><strong><strong>Translation</strong></strong>: Converts to <code
class="verbatim">HotSwapException</code> with descriptive message</li>
<li><strong><strong>Event Creation</strong></strong>: Creates <code
class="verbatim">ClassRedefinitionFailed</code> event</li>
<li><strong><strong>Recovery Guidance</strong></strong>: Provides
actionable recovery suggestions</li>
</ul>
<p>### Unmodifiable Class Errors When attempting to modify system or
final classes:</p>
<ul>
<li><strong><strong>Detection</strong></strong>: Catches <code
class="verbatim">UnmodifiableClassException</code> from JVM</li>
<li><strong><strong>Validation Support</strong></strong>: Provides
pre-validation through <code
class="verbatim">isModifiableClass</code></li>
<li><strong><strong>Clear Messaging</strong></strong>: Explains why
modification is not possible</li>
<li><strong><strong>Alternative Guidance</strong></strong>: Suggests
alternative approaches when applicable</li>
</ul>
<p>### Unsupported Operation Errors When JVM doesn't support required
operations:</p>
<ul>
<li><strong><strong>Capability Detection</strong></strong>: Provides
pre-flight capability checking</li>
<li><strong><strong>Clear Exceptions</strong></strong>: Explains which
operations are not supported</li>
<li><strong><strong>Graceful Degradation</strong></strong>: Enables
fallback strategies in calling code</li>
<li><strong><strong>Environment Documentation</strong></strong>: Helps
identify JVM configuration issues</li>
</ul>
<p>## Performance Considerations</p>
<p>### Direct JVM Integration The service provides direct access to JVM
capabilities:</p>
<ul>
<li><strong><strong>Minimal Overhead</strong></strong>: Direct
delegation to JVM APIs</li>
<li><strong><strong>No Caching</strong></strong>: Relies on JVM's native
performance characteristics</li>
<li><strong><strong>Batch Operations</strong></strong>: Supports
efficient batch class redefinition</li>
<li><strong><strong>Native Performance</strong></strong>: Leverages
JVM's optimized instrumentation implementation</li>
</ul>
<p>### Memory Management The service manages memory efficiently:</p>
<ul>
<li><strong><strong>No State Caching</strong></strong>: Doesn't cache
JVM state that might become stale</li>
<li><strong><strong>Direct References</strong></strong>: Uses direct
references to JVM-managed data</li>
<li><strong><strong>Automatic Cleanup</strong></strong>: Relies on JVM
garbage collection for memory management</li>
<li><strong><strong>Minimal Footprint</strong></strong>: Maintains
minimal memory footprint through stateless design</li>
</ul>
<p>## Testing Considerations</p>
<p>### Instrumentation Mock Support The service design supports
testing:</p>
<ul>
<li><strong><strong>Interface Implementation</strong></strong>: Can be
mocked through <code class="verbatim">InstrumentationService</code>
interface</li>
<li><strong><strong>Dependency Injection</strong></strong>:
Instrumentation instance can be mocked for testing</li>
<li><strong><strong>Exception Testing</strong></strong>: Exception paths
can be tested through mock instrumentation</li>
<li><strong><strong>Capability Testing</strong></strong>: JVM
capabilities can be simulated for comprehensive testing</li>
</ul>
<p>### Integration Testing Real instrumentation testing
considerations:</p>
<ul>
<li><strong><strong>JVM Agent Required</strong></strong>: Integration
tests require JVM agent setup</li>
<li><strong><strong>Class Loading</strong></strong>: Tests must manage
class loading and redefinition carefully</li>
<li><strong><strong>Isolation</strong></strong>: Tests must ensure
proper isolation between redefinition operations</li>
<li><strong><strong>Cleanup</strong></strong>: Tests must clean up
modified classes appropriately</li>
</ul>
<p>The <code class="verbatim">JvmInstrumentationService</code> provides
a robust, domain-appropriate implementation of JVM instrumentation
capabilities, serving as the foundation for ByteHot's hot-swapping
functionality while maintaining clean domain boundaries and
comprehensive error handling.</p></li>
</ol>
</main>
<div class="footer">
    ByteHot - Revolutionary JVM Hot-Swapping | 
    <a href="https://github.com/rydnr/bytehot">GitHub</a> | 
    <a href="https://rydnr.github.io/bytehot/docs/">Documentation</a> | 
    <a href="https://rydnr.github.io/bytehot/javadocs/">API Docs</a>
</div>
</body></html>
