<!DOCTYPE html>
<html>
<head>
    <title>InstrumentationService - ByteHot Documentation</title>
    <link rel="stylesheet" href="../style.css">
</head>
<body>
<div class="navigation">
    <a href="../index.html">üè† Home</a>
    <a href="../implementation.html">üèóÔ∏è Implementation</a>
    <a href="../journal.html">üìî Journal</a>
    <a href="../docs/">üìö Docs</a>
    <a href="../javadocs/">üìñ Javadocs</a>
    <a href="https://github.com/rydnr/bytehot">üîó GitHub</a>
</div>
<main>
<h1 id="instrumentationservice">InstrumentationService</h1>
<h2 id="overview">Overview</h2>
<p>The <code class="verbatim">InstrumentationService</code> is a core
domain service that provides a clean abstraction over JVM
instrumentation capabilities. This service replaces the previous
port/adapter pattern for instrumentation, centralizing all JVM
instrumentation operations into a single, well-defined domain
service.</p>
<h2 id="architecture-role">Architecture Role</h2>
<h3 id="domain-service-pattern">Domain Service Pattern</h3>
<p>The <code class="verbatim">InstrumentationService</code> follows the
Domain Service pattern from Domain-Driven Design:</p>
<ul>
<li>Encapsulates domain logic that doesn't naturally belong to any
entity or value object</li>
<li>Provides stateless operations related to JVM instrumentation</li>
<li>Abstracts complex JVM instrumentation details from domain
aggregates</li>
</ul>
<h3 id="replacement-of-portadapter-pattern">Replacement of Port/Adapter
Pattern</h3>
<p>Previously, ByteHot used:</p>
<ul>
<li><code class="verbatim">InstrumentationPort</code> (domain
interface)</li>
<li><code class="verbatim">InstrumentationAdapter</code> (infrastructure
implementation)</li>
</ul>
<p>This has been simplified to:</p>
<ul>
<li><code class="verbatim">InstrumentationService</code> (domain service
interface)</li>
<li>Concrete implementations in the infrastructure layer</li>
</ul>
<h2 id="core-capabilities">Core Capabilities</h2>
<h3 id="class-redefinition-support">Class Redefinition Support</h3>
<div class="sourceCode" id="cb1"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="dt">boolean</span> <span class="fu">isRedefineClassesSupported</span><span class="op">();</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">redefineClasses</span><span class="op">(</span><span class="bu">ClassDefinition</span><span class="kw">...</span> definitions<span class="op">)</span> <span class="kw">throws</span> HotSwapException<span class="op">;</span></span></code></pre></div>
<p>Provides the fundamental capability to redefine classes at runtime,
which is the core of ByteHot's hot-swapping functionality.</p>
<h3 id="class-retransformation-support">Class Retransformation
Support</h3>
<div class="sourceCode" id="cb2"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="dt">boolean</span> <span class="fu">isRetransformClassesSupported</span><span class="op">();</span></span></code></pre></div>
<p>Checks whether the JVM supports class retransformation, enabling more
advanced hot-swap scenarios.</p>
<h3 id="class-discovery-and-validation">Class Discovery and
Validation</h3>
<div class="sourceCode" id="cb3"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="bu">Class</span><span class="op">&lt;?&gt;[]</span> <span class="fu">getAllLoadedClasses</span><span class="op">();</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="dt">boolean</span> <span class="fu">isModifiable</span><span class="op">(</span><span class="bu">Class</span><span class="op">&lt;?&gt;</span> theClass<span class="op">);</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="bu">Class</span><span class="op">&lt;?&gt;</span> <span class="fu">findLoadedClass</span><span class="op">(</span><span class="bu">String</span> className<span class="op">);</span></span></code></pre></div>
<p>Enables discovery and validation of loaded classes to determine
hot-swap eligibility.</p>
<h2 id="integration-with-domain-aggregates">Integration with Domain
Aggregates</h2>
<h3 id="hotswapmanager-integration">HotSwapManager Integration</h3>
<p>The <code class="verbatim">HotSwapManager</code> aggregate uses <code
class="verbatim">InstrumentationService</code> for:</p>
<ul>
<li>Validating class redefinition capabilities</li>
<li>Performing actual class redefinitions</li>
<li>Discovering loaded classes for hot-swap operations</li>
</ul>
<div class="sourceCode" id="cb4"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> HotSwapManager <span class="op">{</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> InstrumentationService instrumentationService<span class="op">;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">performHotSwap</span><span class="op">(</span><span class="bu">ClassDefinition</span> definition<span class="op">)</span> <span class="kw">throws</span> HotSwapException <span class="op">{</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>instrumentationService<span class="op">.</span><span class="fu">isRedefineClassesSupported</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>            instrumentationService<span class="op">.</span><span class="fu">redefineClasses</span><span class="op">(</span>definition<span class="op">);</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="bytecodevalidator-integration">BytecodeValidator
Integration</h3>
<p>The <code class="verbatim">BytecodeValidator</code> leverages <code
class="verbatim">InstrumentationService</code> to:</p>
<ul>
<li>Check class modification compatibility</li>
<li>Validate redefinition constraints</li>
<li>Ensure JVM capability alignment</li>
</ul>
<h2 id="service-responsibilities">Service Responsibilities</h2>
<h3 id="primary-responsibilities">Primary Responsibilities</h3>
<ul>
<li>Abstract JVM instrumentation capabilities for domain layer</li>
<li>Provide type-safe interface for class redefinition operations</li>
<li>Encapsulate instrumentation capability detection logic</li>
<li>Maintain clean separation between domain and infrastructure
concerns</li>
</ul>
<h3 id="invariants">Invariants</h3>
<ul>
<li>All redefinition operations must check capabilities before
execution</li>
<li>Service remains stateless and thread-safe</li>
<li>Exceptions are properly translated to domain-specific types</li>
<li>No direct dependency on infrastructure instrumentation
libraries</li>
</ul>
<h2 id="implementation-strategy">Implementation Strategy</h2>
<h3 id="interface-definition">Interface Definition</h3>
<p>The service is defined as a domain interface in the domain layer:</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> org</span><span class="op">.</span><span class="im">acmsl</span><span class="op">.</span><span class="im">bytehot</span><span class="op">.</span><span class="im">domain</span><span class="op">;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">interface</span> InstrumentationService <span class="op">{</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Core instrumentation operations</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="infrastructure-implementation">Infrastructure
Implementation</h3>
<p>Concrete implementations reside in the infrastructure layer and
handle:</p>
<ul>
<li>Integration with <code
class="verbatim">java.lang.instrument.Instrumentation</code></li>
<li>JVM-specific capability detection</li>
<li>Error handling and exception translation</li>
<li>Performance optimization for instrumentation operations</li>
</ul>
<h2 id="advantages-over-portadapter-pattern">Advantages Over
Port/Adapter Pattern</h2>
<h3 id="simplified-architecture">Simplified Architecture</h3>
<ul>
<li>Reduces complexity by eliminating separate port and adapter
concepts</li>
<li>Creates direct service-based interaction model</li>
<li>Maintains clear domain/infrastructure separation</li>
</ul>
<h3 id="improved-clarity">Improved Clarity</h3>
<ul>
<li>Service name clearly indicates instrumentation domain
responsibility</li>
<li>Eliminates confusion between ports and adapters</li>
<li>Provides single point of truth for instrumentation capabilities</li>
</ul>
<h3 id="enhanced-maintainability">Enhanced Maintainability</h3>
<ul>
<li>Centralized instrumentation logic in one service interface</li>
<li>Simplified dependency injection and testing</li>
<li>Clearer evolution path for instrumentation enhancements</li>
</ul>
<h2 id="testing-strategy">Testing Strategy</h2>
<h3 id="unit-testing">Unit Testing</h3>
<ul>
<li>Mock <code class="verbatim">InstrumentationService</code> for
aggregate testing</li>
<li>Test capability detection logic separately</li>
<li>Validate exception handling and edge cases</li>
</ul>
<h3 id="integration-testing">Integration Testing</h3>
<ul>
<li>Test real JVM instrumentation capabilities</li>
<li>Validate class redefinition workflows end-to-end</li>
<li>Ensure proper error propagation from infrastructure</li>
</ul>
<h2 id="future-evolution">Future Evolution</h2>
<h3 id="potential-enhancements">Potential Enhancements</h3>
<ul>
<li>Support for advanced instrumentation features</li>
<li>Integration with newer JVM instrumentation APIs</li>
<li>Performance optimization for high-frequency operations</li>
<li>Enhanced debugging and monitoring capabilities</li>
</ul>
<h3 id="backward-compatibility">Backward Compatibility</h3>
<ul>
<li>Service interface allows for implementation evolution</li>
<li>Infrastructure changes don't affect domain logic</li>
<li>Clear migration path for instrumentation improvements</li>
</ul>
<p>This <code class="verbatim">InstrumentationService</code> represents
a significant architectural improvement in ByteHot's approach to JVM
instrumentation, providing a cleaner, more maintainable abstraction that
better serves the domain's needs while maintaining strict architectural
boundaries.</p>
</main>
<div class="footer">
    ByteHot - Revolutionary JVM Hot-Swapping | 
    <a href="https://github.com/rydnr/bytehot">GitHub</a> | 
    <a href="https://rydnr.github.io/bytehot/docs/">Documentation</a> | 
    <a href="https://rydnr.github.io/bytehot/javadocs/">API Docs</a>
</div>
</body></html>
