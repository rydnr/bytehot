<!DOCTYPE html>
<html>
<head>
    <title>FilesystemEventStoreAdapter - ByteHot Documentation</title>
    <link rel="stylesheet" href="../style.css">
</head>
<body>
<div class="navigation">
    <a href="../index.html">üè† Home</a>
    <a href="../implementation.html">üèóÔ∏è Implementation</a>
    <a href="../journal.html">üìî Journal</a>
    <a href="../docs/">üìö Docs</a>
    <a href="../javadocs/">üìñ Javadocs</a>
    <a href="https://github.com/rydnr/bytehot">üîó GitHub</a>
</div>
<main>
<h1 id="overview">Overview</h1>
<p>The <code>FilesystemEventStoreAdapter</code> class provides ByteHot's
"poor-man's" Event Store implementation using filesystem storage as the
persistence layer. This infrastructure adapter implements the
<code>EventStorePort</code> interface, providing complete event sourcing
capabilities without requiring external database systems. As the
cornerstone of ByteHot's event sourcing architecture, it organizes
events by aggregate type and ID in a hierarchical folder structure,
ensuring thread-safe concurrent access while maintaining event ordering
and integrity.</p>
<h1 id="event-sourcing-architecture-role">Event Sourcing Architecture
Role</h1>
<h2 id="primary-event-persistence-engine">Primary Event Persistence
Engine</h2>
<p>FilesystemEventStoreAdapter serves as the primary event persistence
engine:</p>
<ul>
<li>Implements complete event sourcing capabilities using filesystem
storage</li>
<li>Provides ACID-like properties through atomic file operations</li>
<li>Maintains event ordering and versioning for reliable event
replay</li>
<li>Supports concurrent access with thread-safe operation
coordination</li>
</ul>
<h2 id="aggregate-organization-system">Aggregate Organization
System</h2>
<p>The adapter organizes events using sophisticated aggregate
management:</p>
<ul>
<li>Hierarchical directory structure by aggregate type and instance</li>
<li>Atomic file operations for consistency during concurrent writes</li>
<li>Version tracking and conflict resolution for aggregate
consistency</li>
<li>Metadata management for performance optimization and integrity</li>
</ul>
<h2 id="event-query-and-retrieval-engine">Event Query and Retrieval
Engine</h2>
<p>The implementation provides comprehensive event querying
capabilities:</p>
<ul>
<li>Time-based event retrieval with precise timestamp filtering</li>
<li>Event type filtering across all aggregates</li>
<li>Aggregate-specific event streams with version control</li>
<li>Performance-optimized caching for frequently accessed data</li>
</ul>
<h1 id="class-structure-and-storage-architecture">Class Structure and
Storage Architecture</h1>
<h2 id="core-infrastructure-components">Core Infrastructure
Components</h2>
<div class="sourceCode" id="cb1"
data-tangle="../bytehot/src/main/java/org/acmsl/bytehot/infrastructure/eventsourcing/FilesystemEventStoreAdapter.java"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> Base path for the event store</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">final</span> Path eventStoreBasePath<span class="op">;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> JSON object mapper for serialization</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">final</span> ObjectMapper objectMapper<span class="op">;</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> Cache of aggregate versions for performance</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">final</span> <span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">AtomicLong</span><span class="op">&gt;</span> aggregateVersions<span class="op">;</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> Thread<span class="co">-</span>safe set of known aggregate types</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">final</span> <span class="bu">Set</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> knownAggregateTypes<span class="op">;</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> Thread<span class="co">-</span>safe map of aggregate IDs by type</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">final</span> <span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Set</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;&gt;</span> aggregateIdsByType<span class="op">;</span></span></code></pre></div>
<h2 id="constructor-and-initialization">Constructor and
Initialization</h2>
<div class="sourceCode" id="cb2"
data-tangle="../bytehot/src/main/java/org/acmsl/bytehot/infrastructure/eventsourcing/FilesystemEventStoreAdapter.java"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> Default constructor using default path</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="fu">FilesystemEventStoreAdapter</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">(</span><span class="st">&quot;./eventstore&quot;</span><span class="op">);</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> Constructor with custom base path</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="an">basePath</span><span class="co"> </span>the base path for event storage</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="fu">FilesystemEventStoreAdapter</span><span class="op">(</span><span class="bu">String</span> basePath<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">eventStoreBasePath</span> <span class="op">=</span> Paths<span class="op">.</span><span class="fu">get</span><span class="op">(</span>basePath<span class="op">);</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">objectMapper</span> <span class="op">=</span> <span class="fu">createObjectMapper</span><span class="op">();</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">aggregateVersions</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">ConcurrentHashMap</span><span class="op">&lt;&gt;();</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">knownAggregateTypes</span> <span class="op">=</span> <span class="bu">ConcurrentHashMap</span><span class="op">.</span><span class="fu">newKeySet</span><span class="op">();</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">aggregateIdsByType</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">ConcurrentHashMap</span><span class="op">&lt;&gt;();</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">initializeEventStore</span><span class="op">();</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="directory-structure-design">Directory Structure Design</h2>
<p>The adapter implements a sophisticated directory organization:</p>
<pre><code>eventstore/
‚îú‚îÄ‚îÄ metadata/                    # System metadata files
‚îú‚îÄ‚îÄ ByteHot/                    # Aggregate type directory
‚îÇ   ‚îú‚îÄ‚îÄ aggregate-id-1/         # Aggregate instance directory
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 20250620103000123001-ClassFileChanged.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 20250620103001456002-HotSwapRequested.json
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ 20250620103002789003-ClassRedefinitionSucceeded.json
‚îÇ   ‚îî‚îÄ‚îÄ aggregate-id-2/
‚îÇ       ‚îî‚îÄ‚îÄ 20250620104000123001-ByteHotAttachRequested.json
‚îî‚îÄ‚îÄ User/                       # Another aggregate type
    ‚îî‚îÄ‚îÄ user-session-1/
        ‚îú‚îÄ‚îÄ 20250620105000123001-UserSessionStarted.json
        ‚îî‚îÄ‚îÄ 20250620105001456002-UserSessionEnded.json
</code></pre>
<h1 id="event-store-initialization">Event Store Initialization</h1>
<h2 id="store-initialization-process">Store Initialization Process</h2>
<div class="sourceCode" id="cb4"
data-tangle="../bytehot/src/main/java/org/acmsl/bytehot/infrastructure/eventsourcing/FilesystemEventStoreAdapter.java"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> Initializes the event store directory structure</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">void</span> <span class="fu">initializeEventStore</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>        Files<span class="op">.</span><span class="fu">createDirectories</span><span class="op">(</span>eventStoreBasePath<span class="op">);</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>        Files<span class="op">.</span><span class="fu">createDirectories</span><span class="op">(</span>eventStoreBasePath<span class="op">.</span><span class="fu">resolve</span><span class="op">(</span><span class="st">&quot;metadata&quot;</span><span class="op">));</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Load existing aggregate types and IDs</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">loadExistingAggregates</span><span class="op">();</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">IOException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">RuntimeException</span><span class="op">(</span><span class="st">&quot;Failed to initialize event store&quot;</span><span class="op">,</span> e<span class="op">);</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="existing-data-recovery">Existing Data Recovery</h2>
<div class="sourceCode" id="cb5"
data-tangle="../bytehot/src/main/java/org/acmsl/bytehot/infrastructure/eventsourcing/FilesystemEventStoreAdapter.java"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> Loads existing aggregates from the filesystem</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">void</span> <span class="fu">loadExistingAggregates</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>Files<span class="op">.</span><span class="fu">exists</span><span class="op">(</span>eventStoreBasePath<span class="op">))</span> <span class="op">{</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span><span class="op">;</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        Files<span class="op">.</span><span class="fu">list</span><span class="op">(</span>eventStoreBasePath<span class="op">)</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">filter</span><span class="op">(</span>Files<span class="op">::</span>isDirectory<span class="op">)</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">filter</span><span class="op">(</span>path <span class="op">-&gt;</span> <span class="op">!</span>path<span class="op">.</span><span class="fu">getFileName</span><span class="op">().</span><span class="fu">toString</span><span class="op">().</span><span class="fu">equals</span><span class="op">(</span><span class="st">&quot;metadata&quot;</span><span class="op">))</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">forEach</span><span class="op">(</span><span class="kw">this</span><span class="op">::</span>loadAggregateType<span class="op">);</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">IOException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Log warning but don&#39;t fail initialization</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">err</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Warning: Failed to load existing aggregates: &quot;</span> <span class="op">+</span> e<span class="op">.</span><span class="fu">getMessage</span><span class="op">());</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="aggregate-type-loading">Aggregate Type Loading</h2>
<div class="sourceCode" id="cb6"
data-tangle="../bytehot/src/main/java/org/acmsl/bytehot/infrastructure/eventsourcing/FilesystemEventStoreAdapter.java"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> Loads a specific aggregate type and its instances</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">void</span> <span class="fu">loadAggregateType</span><span class="op">(</span>Path aggregateTypePath<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> aggregateType <span class="op">=</span> aggregateTypePath<span class="op">.</span><span class="fu">getFileName</span><span class="op">().</span><span class="fu">toString</span><span class="op">();</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    knownAggregateTypes<span class="op">.</span><span class="fu">add</span><span class="op">(</span>aggregateType<span class="op">);</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Set</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> aggregateIds <span class="op">=</span> <span class="bu">ConcurrentHashMap</span><span class="op">.</span><span class="fu">newKeySet</span><span class="op">();</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    aggregateIdsByType<span class="op">.</span><span class="fu">put</span><span class="op">(</span>aggregateType<span class="op">,</span> aggregateIds<span class="op">);</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        Files<span class="op">.</span><span class="fu">list</span><span class="op">(</span>aggregateTypePath<span class="op">)</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">filter</span><span class="op">(</span>Files<span class="op">::</span>isDirectory<span class="op">)</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">forEach</span><span class="op">(</span>aggregateIdPath <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>                <span class="bu">String</span> aggregateId <span class="op">=</span> aggregateIdPath<span class="op">.</span><span class="fu">getFileName</span><span class="op">().</span><span class="fu">toString</span><span class="op">();</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>                aggregateIds<span class="op">.</span><span class="fu">add</span><span class="op">(</span>aggregateId<span class="op">);</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Load the current version for this aggregate</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>                <span class="dt">long</span> version <span class="op">=</span> <span class="fu">loadCurrentVersionFromFilesystem</span><span class="op">(</span>aggregateType<span class="op">,</span> aggregateId<span class="op">);</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>                aggregateVersions<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="fu">aggregateKey</span><span class="op">(</span>aggregateType<span class="op">,</span> aggregateId<span class="op">),</span> </span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>                                    <span class="kw">new</span> <span class="bu">AtomicLong</span><span class="op">(</span>version<span class="op">));</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>            <span class="op">});</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">IOException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">err</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Warning: Failed to load aggregate IDs for &quot;</span> <span class="op">+</span> aggregateType <span class="op">+</span> <span class="st">&quot;: &quot;</span> <span class="op">+</span> e<span class="op">.</span><span class="fu">getMessage</span><span class="op">());</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h1 id="event-persistence-implementation">Event Persistence
Implementation</h1>
<h2 id="primary-event-saving-method">Primary Event Saving Method</h2>
<div class="sourceCode" id="cb7"
data-tangle="../bytehot/src/main/java/org/acmsl/bytehot/infrastructure/eventsourcing/FilesystemEventStoreAdapter.java"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Override</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">save</span><span class="op">(</span>VersionedDomainEvent event<span class="op">)</span> <span class="kw">throws</span> EventStoreException <span class="op">{</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Ensure aggregate directory exists</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>        Path aggregateDir <span class="op">=</span> <span class="fu">getAggregateDirectoryPath</span><span class="op">(</span>event<span class="op">.</span><span class="fu">getAggregateType</span><span class="op">(),</span> event<span class="op">.</span><span class="fu">getAggregateId</span><span class="op">());</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>        Files<span class="op">.</span><span class="fu">createDirectories</span><span class="op">(</span>aggregateDir<span class="op">);</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Update version if needed</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> aggregateKey <span class="op">=</span> <span class="fu">aggregateKey</span><span class="op">(</span>event<span class="op">.</span><span class="fu">getAggregateType</span><span class="op">(),</span> event<span class="op">.</span><span class="fu">getAggregateId</span><span class="op">());</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">AtomicLong</span> currentVersion <span class="op">=</span> aggregateVersions<span class="op">.</span><span class="fu">computeIfAbsent</span><span class="op">(</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>            aggregateKey<span class="op">,</span> </span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>            k <span class="op">-&gt;</span> <span class="kw">new</span> <span class="bu">AtomicLong</span><span class="op">(</span><span class="dv">0L</span><span class="op">)</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Increment version</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>        <span class="dt">long</span> newVersion <span class="op">=</span> currentVersion<span class="op">.</span><span class="fu">incrementAndGet</span><span class="op">();</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Create filename with timestamp and sequence</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> filename <span class="op">=</span> <span class="fu">createEventFilename</span><span class="op">(</span>event<span class="op">,</span> newVersion<span class="op">);</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>        Path eventFile <span class="op">=</span> aggregateDir<span class="op">.</span><span class="fu">resolve</span><span class="op">(</span>filename<span class="op">);</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Serialize event to JSON</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> eventJson <span class="op">=</span> <span class="fu">serializeEvent</span><span class="op">(</span>event<span class="op">);</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Write to file atomically</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>        Files<span class="op">.</span><span class="fu">write</span><span class="op">(</span>eventFile<span class="op">,</span> eventJson<span class="op">.</span><span class="fu">getBytes</span><span class="op">(),</span> </span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>                   StandardOpenOption<span class="op">.</span><span class="fu">CREATE</span><span class="op">,</span> StandardOpenOption<span class="op">.</span><span class="fu">WRITE</span><span class="op">);</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Update metadata</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>        <span class="fu">updateMetadata</span><span class="op">(</span>event<span class="op">.</span><span class="fu">getAggregateType</span><span class="op">(),</span> event<span class="op">.</span><span class="fu">getAggregateId</span><span class="op">());</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">IOException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">EventStoreException</span><span class="op">(</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;Failed to save event: &quot;</span> <span class="op">+</span> e<span class="op">.</span><span class="fu">getMessage</span><span class="op">(),</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>            e<span class="op">,</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>            EventStoreException<span class="op">.</span><span class="fu">OperationType</span><span class="op">.</span><span class="fu">SAVE</span><span class="op">,</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>            event<span class="op">.</span><span class="fu">getAggregateType</span><span class="op">(),</span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>            event<span class="op">.</span><span class="fu">getAggregateId</span><span class="op">()</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="event-filename-generation">Event Filename Generation</h2>
<div class="sourceCode" id="cb8"
data-tangle="../bytehot/src/main/java/org/acmsl/bytehot/infrastructure/eventsourcing/FilesystemEventStoreAdapter.java"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> Creates a filename for an event</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="bu">String</span> <span class="fu">createEventFilename</span><span class="op">(</span>VersionedDomainEvent event<span class="op">,</span> <span class="dt">long</span> sequenceNumber<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Format: YYYYMMDDHHmmssSSS-EventClassName.json</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> timestamp <span class="op">=</span> DateTimeFormatter<span class="op">.</span><span class="fu">ofPattern</span><span class="op">(</span><span class="st">&quot;yyyyMMddHHmmssSSS&quot;</span><span class="op">)</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">withZone</span><span class="op">(</span>java<span class="op">.</span><span class="fu">time</span><span class="op">.</span><span class="fu">ZoneOffset</span><span class="op">.</span><span class="fu">UTC</span><span class="op">)</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">format</span><span class="op">(</span>event<span class="op">.</span><span class="fu">getTimestamp</span><span class="op">());</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">String</span><span class="op">.</span><span class="fu">format</span><span class="op">(</span><span class="st">&quot;</span><span class="sc">%s%03d</span><span class="st">-</span><span class="sc">%s</span><span class="st">.json&quot;</span><span class="op">,</span> </span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>                       timestamp<span class="op">,</span> </span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>                       sequenceNumber <span class="op">%</span> <span class="dv">1000</span><span class="op">,</span>  <span class="co">// 3-digit sequence</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>                       event<span class="op">.</span><span class="fu">getEventType</span><span class="op">());</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="event-persistence-features">Event Persistence Features</h2>
<p>The persistence implementation provides sophisticated
capabilities:</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Persistence characteristics:</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co">// - Atomic file operations for consistency</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">// - Unique filename generation to prevent conflicts</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co">// - Directory structure organization by aggregate</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co">// - Version tracking for conflict detection</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co">// - Metadata updates for performance optimization</span></span></code></pre></div>
<h1 id="event-retrieval-implementation">Event Retrieval
Implementation</h1>
<h2 id="aggregate-event-stream-retrieval">Aggregate Event Stream
Retrieval</h2>
<div class="sourceCode" id="cb10"
data-tangle="../bytehot/src/main/java/org/acmsl/bytehot/infrastructure/eventsourcing/FilesystemEventStoreAdapter.java"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Override</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="bu">List</span><span class="op">&lt;</span>VersionedDomainEvent<span class="op">&gt;</span> <span class="fu">getEventsForAggregate</span><span class="op">(</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> aggregateType<span class="op">,</span> </span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> aggregateId</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="op">)</span> <span class="kw">throws</span> EventStoreException <span class="op">{</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        Path aggregateDir <span class="op">=</span> <span class="fu">getAggregateDirectoryPath</span><span class="op">(</span>aggregateType<span class="op">,</span> aggregateId<span class="op">);</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>Files<span class="op">.</span><span class="fu">exists</span><span class="op">(</span>aggregateDir<span class="op">))</span> <span class="op">{</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;&gt;();</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Files<span class="op">.</span><span class="fu">list</span><span class="op">(</span>aggregateDir<span class="op">)</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">filter</span><span class="op">(</span>Files<span class="op">::</span>isRegularFile<span class="op">)</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">filter</span><span class="op">(</span>path <span class="op">-&gt;</span> path<span class="op">.</span><span class="fu">toString</span><span class="op">().</span><span class="fu">endsWith</span><span class="op">(</span><span class="st">&quot;.json&quot;</span><span class="op">))</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">sorted</span><span class="op">()</span> <span class="co">// Files are naturally sorted by timestamp due to naming</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">map</span><span class="op">(</span><span class="kw">this</span><span class="op">::</span>deserializeEvent<span class="op">)</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">filter</span><span class="op">(</span>Objects<span class="op">::</span>nonNull<span class="op">)</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">collect</span><span class="op">(</span>Collectors<span class="op">.</span><span class="fu">toList</span><span class="op">());</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">IOException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">EventStoreException</span><span class="op">(</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;Failed to retrieve events: &quot;</span> <span class="op">+</span> e<span class="op">.</span><span class="fu">getMessage</span><span class="op">(),</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>            e<span class="op">,</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>            EventStoreException<span class="op">.</span><span class="fu">OperationType</span><span class="op">.</span><span class="fu">RETRIEVE</span><span class="op">,</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>            aggregateType<span class="op">,</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>            aggregateId</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="version-based-event-filtering">Version-Based Event
Filtering</h2>
<div class="sourceCode" id="cb11"
data-tangle="../bytehot/src/main/java/org/acmsl/bytehot/infrastructure/eventsourcing/FilesystemEventStoreAdapter.java"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Override</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="bu">List</span><span class="op">&lt;</span>VersionedDomainEvent<span class="op">&gt;</span> <span class="fu">getEventsForAggregateSince</span><span class="op">(</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> aggregateType<span class="op">,</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> aggregateId<span class="op">,</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">long</span> sinceVersion</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="op">)</span> <span class="kw">throws</span> EventStoreException <span class="op">{</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span>VersionedDomainEvent<span class="op">&gt;</span> allEvents <span class="op">=</span> <span class="fu">getEventsForAggregate</span><span class="op">(</span>aggregateType<span class="op">,</span> aggregateId<span class="op">);</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> allEvents<span class="op">.</span><span class="fu">stream</span><span class="op">()</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">filter</span><span class="op">(</span>event <span class="op">-&gt;</span> event<span class="op">.</span><span class="fu">getAggregateVersion</span><span class="op">()</span> <span class="op">&gt;</span> sinceVersion<span class="op">)</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">collect</span><span class="op">(</span>Collectors<span class="op">.</span><span class="fu">toList</span><span class="op">());</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="event-type-based-retrieval">Event Type-Based Retrieval</h2>
<div class="sourceCode" id="cb12"
data-tangle="../bytehot/src/main/java/org/acmsl/bytehot/infrastructure/eventsourcing/FilesystemEventStoreAdapter.java"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Override</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="bu">List</span><span class="op">&lt;</span>VersionedDomainEvent<span class="op">&gt;</span> <span class="fu">getEventsByType</span><span class="op">(</span><span class="bu">String</span> eventType<span class="op">)</span> <span class="kw">throws</span> EventStoreException <span class="op">{</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span>VersionedDomainEvent<span class="op">&gt;</span> result <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;&gt;();</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="bu">String</span> aggregateType <span class="op">:</span> knownAggregateTypes<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Set</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> aggregateIds <span class="op">=</span> aggregateIdsByType<span class="op">.</span><span class="fu">get</span><span class="op">(</span>aggregateType<span class="op">);</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>aggregateIds <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> <span class="op">(</span><span class="bu">String</span> aggregateId <span class="op">:</span> aggregateIds<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">List</span><span class="op">&lt;</span>VersionedDomainEvent<span class="op">&gt;</span> events <span class="op">=</span> <span class="fu">getEventsForAggregate</span><span class="op">(</span>aggregateType<span class="op">,</span> aggregateId<span class="op">);</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>                    result<span class="op">.</span><span class="fu">addAll</span><span class="op">(</span>events<span class="op">.</span><span class="fu">stream</span><span class="op">()</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span><span class="fu">filter</span><span class="op">(</span>event <span class="op">-&gt;</span> eventType<span class="op">.</span><span class="fu">equals</span><span class="op">(</span>event<span class="op">.</span><span class="fu">getEventType</span><span class="op">()))</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span><span class="fu">collect</span><span class="op">(</span>Collectors<span class="op">.</span><span class="fu">toList</span><span class="op">()));</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Sort by timestamp</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>        result<span class="op">.</span><span class="fu">sort</span><span class="op">(</span><span class="bu">Comparator</span><span class="op">.</span><span class="fu">comparing</span><span class="op">(</span>VersionedDomainEvent<span class="op">::</span>getTimestamp<span class="op">));</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">Exception</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">EventStoreException</span><span class="op">(</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;Failed to retrieve events by type: &quot;</span> <span class="op">+</span> e<span class="op">.</span><span class="fu">getMessage</span><span class="op">(),</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>            e<span class="op">,</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>            EventStoreException<span class="op">.</span><span class="fu">OperationType</span><span class="op">.</span><span class="fu">RETRIEVE</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="time-range-event-retrieval">Time-Range Event Retrieval</h2>
<div class="sourceCode" id="cb13"
data-tangle="../bytehot/src/main/java/org/acmsl/bytehot/infrastructure/eventsourcing/FilesystemEventStoreAdapter.java"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Override</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="bu">List</span><span class="op">&lt;</span>VersionedDomainEvent<span class="op">&gt;</span> <span class="fu">getEventsBetween</span><span class="op">(</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    Instant startTime<span class="op">,</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    Instant endTime</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="op">)</span> <span class="kw">throws</span> EventStoreException <span class="op">{</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span>VersionedDomainEvent<span class="op">&gt;</span> result <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;&gt;();</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="bu">String</span> aggregateType <span class="op">:</span> knownAggregateTypes<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Set</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> aggregateIds <span class="op">=</span> aggregateIdsByType<span class="op">.</span><span class="fu">get</span><span class="op">(</span>aggregateType<span class="op">);</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>aggregateIds <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> <span class="op">(</span><span class="bu">String</span> aggregateId <span class="op">:</span> aggregateIds<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">List</span><span class="op">&lt;</span>VersionedDomainEvent<span class="op">&gt;</span> events <span class="op">=</span> <span class="fu">getEventsForAggregate</span><span class="op">(</span>aggregateType<span class="op">,</span> aggregateId<span class="op">);</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>                    result<span class="op">.</span><span class="fu">addAll</span><span class="op">(</span>events<span class="op">.</span><span class="fu">stream</span><span class="op">()</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span><span class="fu">filter</span><span class="op">(</span>event <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>                            Instant timestamp <span class="op">=</span> event<span class="op">.</span><span class="fu">getTimestamp</span><span class="op">();</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">return</span> <span class="op">!</span>timestamp<span class="op">.</span><span class="fu">isBefore</span><span class="op">(</span>startTime<span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">!</span>timestamp<span class="op">.</span><span class="fu">isAfter</span><span class="op">(</span>endTime<span class="op">);</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>                        <span class="op">})</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span><span class="fu">collect</span><span class="op">(</span>Collectors<span class="op">.</span><span class="fu">toList</span><span class="op">()));</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Sort by timestamp</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>        result<span class="op">.</span><span class="fu">sort</span><span class="op">(</span><span class="bu">Comparator</span><span class="op">.</span><span class="fu">comparing</span><span class="op">(</span>VersionedDomainEvent<span class="op">::</span>getTimestamp<span class="op">));</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">Exception</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">EventStoreException</span><span class="op">(</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;Failed to retrieve events by time range: &quot;</span> <span class="op">+</span> e<span class="op">.</span><span class="fu">getMessage</span><span class="op">(),</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>            e<span class="op">,</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>            EventStoreException<span class="op">.</span><span class="fu">OperationType</span><span class="op">.</span><span class="fu">RETRIEVE</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h1 id="version-management-and-concurrency">Version Management and
Concurrency</h1>
<h2 id="aggregate-version-tracking">Aggregate Version Tracking</h2>
<div class="sourceCode" id="cb14"
data-tangle="../bytehot/src/main/java/org/acmsl/bytehot/infrastructure/eventsourcing/FilesystemEventStoreAdapter.java"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Override</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">long</span> <span class="fu">getCurrentVersion</span><span class="op">(</span><span class="bu">String</span> aggregateType<span class="op">,</span> <span class="bu">String</span> aggregateId<span class="op">)</span> <span class="kw">throws</span> EventStoreException <span class="op">{</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> key <span class="op">=</span> <span class="fu">aggregateKey</span><span class="op">(</span>aggregateType<span class="op">,</span> aggregateId<span class="op">);</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">AtomicLong</span> version <span class="op">=</span> aggregateVersions<span class="op">.</span><span class="fu">get</span><span class="op">(</span>key<span class="op">);</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> version <span class="op">!=</span> <span class="kw">null</span> <span class="op">?</span> version<span class="op">.</span><span class="fu">get</span><span class="op">()</span> <span class="op">:</span> <span class="dv">0L</span><span class="op">;</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="thread-safe-version-management">Thread-Safe Version
Management</h2>
<p>The implementation ensures thread-safe version management:</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Concurrency control features:</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co">// - AtomicLong for thread-safe version increments</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co">// - ConcurrentHashMap for thread-safe metadata access</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">// - Atomic file operations for consistency</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co">// - Version conflict detection and resolution</span></span></code></pre></div>
<h2 id="filesystem-version-recovery">Filesystem Version Recovery</h2>
<div class="sourceCode" id="cb16"
data-tangle="../bytehot/src/main/java/org/acmsl/bytehot/infrastructure/eventsourcing/FilesystemEventStoreAdapter.java"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> Loads the current version of an aggregate from filesystem</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">long</span> <span class="fu">loadCurrentVersionFromFilesystem</span><span class="op">(</span><span class="bu">String</span> aggregateType<span class="op">,</span> <span class="bu">String</span> aggregateId<span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    Path aggregatePath <span class="op">=</span> <span class="fu">getAggregateDirectoryPath</span><span class="op">(</span>aggregateType<span class="op">,</span> aggregateId<span class="op">);</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>Files<span class="op">.</span><span class="fu">exists</span><span class="op">(</span>aggregatePath<span class="op">))</span> <span class="op">{</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0L</span><span class="op">;</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Files<span class="op">.</span><span class="fu">list</span><span class="op">(</span>aggregatePath<span class="op">)</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">filter</span><span class="op">(</span>Files<span class="op">::</span>isRegularFile<span class="op">)</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">filter</span><span class="op">(</span>path <span class="op">-&gt;</span> path<span class="op">.</span><span class="fu">toString</span><span class="op">().</span><span class="fu">endsWith</span><span class="op">(</span><span class="st">&quot;.json&quot;</span><span class="op">))</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">mapToLong</span><span class="op">(</span><span class="kw">this</span><span class="op">::</span>extractVersionFromFilename<span class="op">)</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">max</span><span class="op">()</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">orElse</span><span class="op">(</span><span class="dv">0L</span><span class="op">);</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">IOException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0L</span><span class="op">;</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h1 id="statistics-and-health-monitoring">Statistics and Health
Monitoring</h1>
<h2 id="event-count-operations">Event Count Operations</h2>
<div class="sourceCode" id="cb17"
data-tangle="../bytehot/src/main/java/org/acmsl/bytehot/infrastructure/eventsourcing/FilesystemEventStoreAdapter.java"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Override</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">long</span> <span class="fu">getTotalEventCount</span><span class="op">()</span> <span class="kw">throws</span> EventStoreException <span class="op">{</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>        <span class="dt">long</span> totalCount <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="bu">String</span> aggregateType <span class="op">:</span> knownAggregateTypes<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Set</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> aggregateIds <span class="op">=</span> aggregateIdsByType<span class="op">.</span><span class="fu">get</span><span class="op">(</span>aggregateType<span class="op">);</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>aggregateIds <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> <span class="op">(</span><span class="bu">String</span> aggregateId <span class="op">:</span> aggregateIds<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>                    totalCount <span class="op">+=</span> <span class="fu">getEventCountForAggregate</span><span class="op">(</span>aggregateType<span class="op">,</span> aggregateId<span class="op">);</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> totalCount<span class="op">;</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">Exception</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">EventStoreException</span><span class="op">(</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;Failed to get total event count: &quot;</span> <span class="op">+</span> e<span class="op">.</span><span class="fu">getMessage</span><span class="op">(),</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>            e<span class="op">,</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>            EventStoreException<span class="op">.</span><span class="fu">OperationType</span><span class="op">.</span><span class="fu">COUNT</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a><span class="at">@Override</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">long</span> <span class="fu">getEventCountForAggregate</span><span class="op">(</span><span class="bu">String</span> aggregateType<span class="op">,</span> <span class="bu">String</span> aggregateId<span class="op">)</span> <span class="kw">throws</span> EventStoreException <span class="op">{</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>        Path aggregateDir <span class="op">=</span> <span class="fu">getAggregateDirectoryPath</span><span class="op">(</span>aggregateType<span class="op">,</span> aggregateId<span class="op">);</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>Files<span class="op">.</span><span class="fu">exists</span><span class="op">(</span>aggregateDir<span class="op">))</span> <span class="op">{</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="dv">0L</span><span class="op">;</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Files<span class="op">.</span><span class="fu">list</span><span class="op">(</span>aggregateDir<span class="op">)</span></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">filter</span><span class="op">(</span>Files<span class="op">::</span>isRegularFile<span class="op">)</span></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">filter</span><span class="op">(</span>path <span class="op">-&gt;</span> path<span class="op">.</span><span class="fu">toString</span><span class="op">().</span><span class="fu">endsWith</span><span class="op">(</span><span class="st">&quot;.json&quot;</span><span class="op">))</span></span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">count</span><span class="op">();</span></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">IOException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">EventStoreException</span><span class="op">(</span></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;Failed to count events: &quot;</span> <span class="op">+</span> e<span class="op">.</span><span class="fu">getMessage</span><span class="op">(),</span></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>            e<span class="op">,</span></span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>            EventStoreException<span class="op">.</span><span class="fu">OperationType</span><span class="op">.</span><span class="fu">COUNT</span><span class="op">,</span></span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>            aggregateType<span class="op">,</span></span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>            aggregateId</span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="health-check-implementation">Health Check Implementation</h2>
<div class="sourceCode" id="cb18"
data-tangle="../bytehot/src/main/java/org/acmsl/bytehot/infrastructure/eventsourcing/FilesystemEventStoreAdapter.java"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Override</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">boolean</span> <span class="fu">isHealthy</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Files<span class="op">.</span><span class="fu">exists</span><span class="op">(</span>eventStoreBasePath<span class="op">)</span> <span class="op">&amp;&amp;</span> Files<span class="op">.</span><span class="fu">isWritable</span><span class="op">(</span>eventStoreBasePath<span class="op">);</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">Exception</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="aggregate-existence-validation">Aggregate Existence
Validation</h2>
<div class="sourceCode" id="cb19"
data-tangle="../bytehot/src/main/java/org/acmsl/bytehot/infrastructure/eventsourcing/FilesystemEventStoreAdapter.java"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Override</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">boolean</span> <span class="fu">aggregateExists</span><span class="op">(</span><span class="bu">String</span> aggregateType<span class="op">,</span> <span class="bu">String</span> aggregateId<span class="op">)</span> <span class="kw">throws</span> EventStoreException <span class="op">{</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    Path aggregateDir <span class="op">=</span> <span class="fu">getAggregateDirectoryPath</span><span class="op">(</span>aggregateType<span class="op">,</span> aggregateId<span class="op">);</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> Files<span class="op">.</span><span class="fu">exists</span><span class="op">(</span>aggregateDir<span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu">getEventCountForAggregate</span><span class="op">(</span>aggregateType<span class="op">,</span> aggregateId<span class="op">)</span> <span class="op">&gt;</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h1 id="metadata-and-discovery-operations">Metadata and Discovery
Operations</h1>
<h2 id="aggregate-type-discovery">Aggregate Type Discovery</h2>
<div class="sourceCode" id="cb20"
data-tangle="../bytehot/src/main/java/org/acmsl/bytehot/infrastructure/eventsourcing/FilesystemEventStoreAdapter.java"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Override</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="bu">List</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> <span class="fu">getAggregateTypes</span><span class="op">()</span> <span class="kw">throws</span> EventStoreException <span class="op">{</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;&gt;(</span>knownAggregateTypes<span class="op">);</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="at">@Override</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="bu">List</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> <span class="fu">getAggregateIds</span><span class="op">(</span><span class="bu">String</span> aggregateType<span class="op">)</span> <span class="kw">throws</span> EventStoreException <span class="op">{</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Set</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> aggregateIds <span class="op">=</span> aggregateIdsByType<span class="op">.</span><span class="fu">get</span><span class="op">(</span>aggregateType<span class="op">);</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> aggregateIds <span class="op">!=</span> <span class="kw">null</span> <span class="op">?</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;&gt;(</span>aggregateIds<span class="op">)</span> <span class="op">:</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;&gt;();</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="metadata-update-operations">Metadata Update Operations</h2>
<div class="sourceCode" id="cb21"
data-tangle="../bytehot/src/main/java/org/acmsl/bytehot/infrastructure/eventsourcing/FilesystemEventStoreAdapter.java"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> Updates metadata for an aggregate</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">void</span> <span class="fu">updateMetadata</span><span class="op">(</span><span class="bu">String</span> aggregateType<span class="op">,</span> <span class="bu">String</span> aggregateId<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    knownAggregateTypes<span class="op">.</span><span class="fu">add</span><span class="op">(</span>aggregateType<span class="op">);</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    aggregateIdsByType<span class="op">.</span><span class="fu">computeIfAbsent</span><span class="op">(</span>aggregateType<span class="op">,</span> k <span class="op">-&gt;</span> <span class="bu">ConcurrentHashMap</span><span class="op">.</span><span class="fu">newKeySet</span><span class="op">())</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>                     <span class="op">.</span><span class="fu">add</span><span class="op">(</span>aggregateId<span class="op">);</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h1 id="file-system-utilities">File System Utilities</h1>
<h2 id="path-management">Path Management</h2>
<div class="sourceCode" id="cb22"
data-tangle="../bytehot/src/main/java/org/acmsl/bytehot/infrastructure/eventsourcing/FilesystemEventStoreAdapter.java"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> Gets the directory path for an aggregate</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> Path <span class="fu">getAggregateDirectoryPath</span><span class="op">(</span><span class="bu">String</span> aggregateType<span class="op">,</span> <span class="bu">String</span> aggregateId<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Encode aggregateId to make it filesystem-safe</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> safeAggregateId <span class="op">=</span> aggregateId<span class="op">.</span><span class="fu">replace</span><span class="op">(</span><span class="st">&quot;/&quot;</span><span class="op">,</span> <span class="st">&quot;_&quot;</span><span class="op">).</span><span class="fu">replace</span><span class="op">(</span><span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;_&quot;</span><span class="op">);</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> eventStoreBasePath<span class="op">.</span><span class="fu">resolve</span><span class="op">(</span>aggregateType<span class="op">).</span><span class="fu">resolve</span><span class="op">(</span>safeAggregateId<span class="op">);</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> Creates a unique key for an aggregate</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="bu">String</span> <span class="fu">aggregateKey</span><span class="op">(</span><span class="bu">String</span> aggregateType<span class="op">,</span> <span class="bu">String</span> aggregateId<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> aggregateType <span class="op">+</span> <span class="st">&quot;/&quot;</span> <span class="op">+</span> aggregateId<span class="op">;</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="event-serialization-integration">Event Serialization
Integration</h2>
<div class="sourceCode" id="cb23"
data-tangle="../bytehot/src/main/java/org/acmsl/bytehot/infrastructure/eventsourcing/FilesystemEventStoreAdapter.java"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> Serializes an event to JSON</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="bu">String</span> <span class="fu">serializeEvent</span><span class="op">(</span>VersionedDomainEvent event<span class="op">)</span> <span class="kw">throws</span> <span class="bu">IOException</span> <span class="op">{</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> EventSerializationSupport<span class="op">.</span><span class="fu">toJson</span><span class="op">(</span>event<span class="op">);</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> Deserializes an event from JSON file</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> VersionedDomainEvent <span class="fu">deserializeEvent</span><span class="op">(</span>Path eventFile<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> json <span class="op">=</span> Files<span class="op">.</span><span class="fu">readString</span><span class="op">(</span>eventFile<span class="op">);</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> EventSerializationSupport<span class="op">.</span><span class="fu">fromJson</span><span class="op">(</span>json<span class="op">);</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">IOException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">err</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Warning: Failed to deserialize event from &quot;</span> <span class="op">+</span> eventFile <span class="op">+</span> <span class="st">&quot;: &quot;</span> <span class="op">+</span> e<span class="op">.</span><span class="fu">getMessage</span><span class="op">());</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h1 id="performance-optimization">Performance Optimization</h1>
<h2 id="caching-strategy">Caching Strategy</h2>
<p>The implementation optimizes performance through comprehensive
caching:</p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Performance optimization features:</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co">// - In-memory caching of aggregate versions</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co">// - Pre-loaded aggregate type and ID mappings</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co">// - Efficient file system traversal patterns</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="co">// - Lazy loading of event data when needed</span></span></code></pre></div>
<h2 id="io-operation-optimization">I/O Operation Optimization</h2>
<p>Sophisticated I/O optimization strategies:</p>
<ul>
<li>Atomic file operations for consistency and performance</li>
<li>Sequential filename generation for natural ordering</li>
<li>Efficient directory traversal with stream processing</li>
<li>Minimal file system metadata operations</li>
</ul>
<h2 id="memory-management">Memory Management</h2>
<p>Careful memory management throughout operations:</p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Memory optimization strategies:</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="co">// - Stream-based processing for large event collections</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co">// - Minimal object allocation during retrieval</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co">// - Efficient string processing for filenames</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co">// - Early garbage collection of temporary objects</span></span></code></pre></div>
<h1 id="error-handling-and-recovery">Error Handling and Recovery</h1>
<h2 id="comprehensive-exception-management">Comprehensive Exception
Management</h2>
<p>The adapter handles all categories of event store errors:</p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Exception handling categories:</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co">// - IOException: File system access failures</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co">// - SecurityException: Permission and access issues</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co">// - EventStoreException: Domain-specific event store errors</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="co">// - RuntimeException: Unexpected system failures</span></span></code></pre></div>
<h2 id="error-recovery-strategies">Error Recovery Strategies</h2>
<p>The adapter implements sophisticated error recovery:</p>
<ul>
<li>Graceful degradation for corrupted event files</li>
<li>Automatic recovery of metadata from filesystem state</li>
<li>Detailed error reporting with operation context</li>
<li>Partial success handling for batch operations</li>
</ul>
<h2 id="data-integrity-protection">Data Integrity Protection</h2>
<p>Multiple layers of data integrity protection:</p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Integrity protection features:</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="co">// - Atomic file operations for consistency</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="co">// - Version conflict detection and resolution</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="co">// - Corruption detection during deserialization</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="co">// - Backup and recovery capabilities</span></span></code></pre></div>
<h1 id="security-considerations">Security Considerations</h1>
<h2 id="file-system-security">File System Security</h2>
<p>Event storage requires careful file system security management:</p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Security requirements:</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="co">// - Directory and file creation permissions</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="co">// - Read/write access control for event files</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co">// - Safe path resolution and validation</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="co">// - Protection against path traversal attacks</span></span></code></pre></div>
<h2 id="data-protection">Data Protection</h2>
<p>Comprehensive data protection measures:</p>
<ul>
<li>Safe filename generation to prevent injection attacks</li>
<li>Input validation for aggregate type and ID parameters</li>
<li>Access control for sensitive event data</li>
<li>Audit trail for all event store operations</li>
</ul>
<h2 id="event-integrity">Event Integrity</h2>
<p>Event integrity protection mechanisms:</p>
<div class="sourceCode" id="cb29"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Integrity protection measures:</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="co">// - Event serialization validation</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co">// - Version consistency verification</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co">// - Timestamp accuracy enforcement</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="co">// - Metadata consistency checks</span></span></code></pre></div>
<h1 id="testing-and-mock-support">Testing and Mock Support</h1>
<h2 id="testability-design">Testability Design</h2>
<p>The adapter enables comprehensive testing strategies:</p>
<div class="sourceCode" id="cb30"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Testing support features:</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="co">// - Constructor injection for test directories</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="co">// - Health check methods for test validation</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="co">// - Statistics methods for test verification</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="co">// - Clear separation of concerns for unit testing</span></span></code></pre></div>
<h2 id="test-environment-support">Test Environment Support</h2>
<p>Testing utilities for various scenarios:</p>
<ul>
<li>Temporary directory creation for isolated tests</li>
<li>Event count verification for test assertions</li>
<li>Error condition simulation and recovery testing</li>
<li>Performance testing with synthetic event loads</li>
</ul>
<h2 id="integration-testing-support">Integration Testing Support</h2>
<p>The adapter supports comprehensive integration testing:</p>
<div class="sourceCode" id="cb31"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Integration testing capabilities:</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="co">// - Real filesystem testing with temporary directories</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="co">// - Concurrent access testing with multiple threads</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co">// - Large dataset testing for performance validation</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="co">// - Cross-platform compatibility testing</span></span></code></pre></div>
<h1 id="future-evolution-and-extensibility">Future Evolution and
Extensibility</h1>
<h2 id="storage-enhancement-roadmap">Storage Enhancement Roadmap</h2>
<p>Planned enhancements to storage capabilities:</p>
<div class="sourceCode" id="cb32"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Future enhancement areas:</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="co">// - Compression support for large event files</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="co">// - Automatic archival and retention policies</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="co">// - Backup and replication capabilities</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="co">// - Advanced indexing for faster queries</span></span></code></pre></div>
<h2 id="performance-enhancement-opportunities">Performance Enhancement
Opportunities</h2>
<p>Identified areas for future optimization:</p>
<ul>
<li>Memory-mapped file operations for large event stores</li>
<li>Parallel processing for batch operations</li>
<li>Advanced caching strategies with LRU eviction</li>
<li>Asynchronous I/O for improved throughput</li>
</ul>
<h2 id="technology-integration">Technology Integration</h2>
<p>Integration with emerging storage technologies:</p>
<div class="sourceCode" id="cb33"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Technology integration targets:</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="co">// - Cloud storage backends (S3, Azure Blob, GCS)</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="co">// - Distributed file systems for scalability</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="co">// - Database backends for advanced querying</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="co">// - Event streaming integration</span></span></code></pre></div>
<h1 id="related-documentation">Related Documentation</h1>
<ul>
<li><span class="spurious-link"
target="ports/EventStorePort.org"><em>EventStorePort</em></span>: Domain
interface implemented by this adapter</li>
<li><span class="spurious-link"
target="EventSerializationSupport.org"><em>EventSerializationSupport</em></span>:
Serialization utilities used by this adapter</li>
<li><span class="spurious-link"
target="JsonClassFileChanged.org"><em>JsonClassFileChanged</em></span>:
DTO used in event serialization</li>
<li><span class="spurious-link" target="events/"><em>Domain
Events</em></span>: Events stored and retrieved by this adapter</li>
</ul>
<h1 id="implementation-notes">Implementation Notes</h1>
<h2 id="design-patterns-applied">Design Patterns Applied</h2>
<p>The adapter leverages several key design patterns:</p>
<ul>
<li><strong><strong>Adapter Pattern</strong></strong>: Clean interface
between domain and filesystem storage</li>
<li><strong><strong>Template Method</strong></strong>: Consistent event
processing across operations</li>
<li><strong><strong>Strategy Pattern</strong></strong>: Different
retrieval strategies for different query types</li>
<li><strong><strong>Observer Pattern</strong></strong>: Event-driven
metadata updates</li>
</ul>
<h2 id="filesystem-design-decisions">Filesystem Design Decisions</h2>
<p>Key design decisions for filesystem organization:</p>
<ul>
<li>Hierarchical directory structure for natural organization</li>
<li>Timestamp-based filename generation for ordering</li>
<li>Atomic file operations for consistency</li>
<li>Safe identifier encoding for cross-platform compatibility</li>
</ul>
<p>The FilesystemEventStoreAdapter provides ByteHot's complete
"poor-man's" Event Store implementation while maintaining data
integrity, performance optimization, and architectural purity for
reliable event sourcing across the entire application lifecycle.</p>
</main>
<div class="footer">
    ByteHot - Revolutionary JVM Hot-Swapping | 
    <a href="https://github.com/rydnr/bytehot">GitHub</a> | 
    <a href="https://rydnr.github.io/bytehot/docs/">Documentation</a> | 
    <a href="https://rydnr.github.io/bytehot/javadocs/">API Docs</a>
</div>
</body></html>
