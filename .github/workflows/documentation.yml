name: Build and Deploy Documentation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run daily at 2 AM UTC to keep documentation fresh
    - cron: '0 2 * * *'

permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for proper git operations

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Install Pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc

      - name: Verify Pandoc installation
        run: pandoc --version

      - name: Build project and run tests
        run: |
          cd bytehot
          mvn clean compile test-compile

      - name: Generate Javadocs
        run: |
          cd bytehot
          # Generate Javadocs with proper classpath
          javadoc -d javadocs \
            -sourcepath src/main/java \
            -classpath "target/classes:$(mvn dependency:build-classpath -Dmdep.outputFile=/dev/stdout -q)" \
            -subpackages org.acmsl.bytehot \
            -windowtitle "ByteHot API Documentation" \
            -doctitle "ByteHot - JVM Bytecode Hot-Swapping Agent" \
            -header "ByteHot v1.0" \
            -bottom "Copyright Â© 2025 ByteHot Project. Licensed under GPL v3." \
            -use -version -author \
            -quiet || echo "Javadoc generation completed with warnings"

      - name: Create or checkout gh-pages branch
        run: |
          # Check if gh-pages branch exists locally
          if git show-ref --verify --quiet refs/heads/gh-pages; then
            echo "Local gh-pages branch exists, checking out..."
            git checkout gh-pages
          else
            # Check if remote gh-pages branch exists
            if git ls-remote --exit-code --heads origin gh-pages; then
              echo "Remote gh-pages branch exists, checking out..."
              git checkout -b gh-pages origin/gh-pages
            else
              echo "Creating new gh-pages branch..."
              git checkout --orphan gh-pages
              git rm -rf .
              # Create initial commit
              echo "# ByteHot Documentation" > README.md
              git add README.md
              git commit -m "ğŸ“š Initialize gh-pages branch for documentation"
            fi
          fi

      - name: Copy Javadocs to gh-pages
        run: |
          # Ensure we're on gh-pages branch
          git checkout gh-pages
          
          # Create bytehot directory if it doesn't exist
          mkdir -p bytehot
          
          # Copy generated javadocs
          cp -r bytehot/javadocs bytehot/javadocs

      - name: Convert org files to HTML
        run: |
          # Ensure we have the necessary files
          git checkout main -- story.org journal.org docs/ || true
          
          # Create style.css from gh-pages branch or use basic styling
          if [ ! -f bytehot/style.css ]; then
            # Try to get existing style.css from gh-pages branch
            git show gh-pages:bytehot/style.css > bytehot/style.css 2>/dev/null || {
              # Create basic style.css if gh-pages doesn't exist
              cat > bytehot/style.css << 'CSSEOF'
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; max-width: 1200px; margin: 0 auto; padding: 20px; background-color: #fafafa; }
.navigation { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px; margin-bottom: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
.navigation a { color: #fff; text-decoration: none; margin: 0 15px; padding: 8px 12px; border-radius: 4px; transition: background-color 0.3s; }
.navigation a:hover { background-color: rgba(255,255,255,0.2); }
h1, h2, h3 { color: #2c3e50; }
h1 { border-bottom: 3px solid #667eea; padding-bottom: 10px; }
code { background-color: #f4f4f4; padding: 2px 6px; border-radius: 3px; font-family: 'Fira Code', 'Monaco', 'Consolas', monospace; }
pre { background-color: #f8f8f8; border: 1px solid #ddd; border-radius: 6px; padding: 15px; overflow-x: auto; }
blockquote { border-left: 4px solid #667eea; margin: 20px 0; padding: 10px 20px; background-color: #f9f9f9; }
table { border-collapse: collapse; width: 100%; margin: 20px 0; }
table th, table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
table th { background-color: #667eea; color: white; }
CSSEOF
            }
          fi
          
          # Convert story.org to index.html with navigation
          pandoc -f org -t html5 -s --css=style.css --toc story.org -o bytehot/index.html --metadata title="ByteHot - Revolutionary JVM Hot-Swapping Agent" || echo "story.org conversion failed, using fallback"
          
          # Add navigation to index.html if conversion succeeded
          if [ -f bytehot/index.html ]; then
            # Create temp file with navigation
            cat > temp_nav.html << 'NAVEOF'
<div class="navigation">
  <strong>ByteHot Documentation</strong> |
  <a href="index.html">ğŸ  Home</a>
  <a href="javadocs/index.html">ğŸ“– API Documentation</a>
  <a href="journal.html">ğŸ“ Development Journal</a>
  <a href="docs/configuration.html">âš™ï¸ Configuration Guide</a>
  <a href="docs/User.html">ğŸ‘¤ User Management</a>
  <a href="docs/flows/user-management-flow.html">ğŸ”„ User Flow</a>
  <a href="https://github.com/rydnr/bytehot">ğŸ”— GitHub</a>
</div>
NAVEOF
            # Insert navigation after <body> tag
            sed -i '/<body>/r temp_nav.html' bytehot/index.html
            rm temp_nav.html
          fi
          
          # Convert journal.org to journal.html
          pandoc -f org -t html5 -s --css=style.css --toc journal.org -o bytehot/journal.html --metadata title="ByteHot Development Journal" || echo "journal.org conversion failed"
          
          # Convert docs/*.org files if they exist
          mkdir -p bytehot/docs bytehot/docs/flows
          
          # Convert documentation files
          for file in docs/*.org docs/*.md; do
            if [ -f "$file" ]; then
              basename=$(basename "$file" .org)
              basename=$(basename "$basename" .md)
              if [[ "$file" == *.org ]]; then
                pandoc -f org -t html5 -s --css=../style.css --toc "$file" -o "bytehot/docs/${basename}.html" || echo "Failed to convert $file"
              else
                pandoc -f markdown -t html5 -s --css=../style.css --toc "$file" -o "bytehot/docs/${basename}.html" || echo "Failed to convert $file"
              fi
            fi
          done
          
          # Convert flow documentation
          for file in docs/flows/*.org; do
            if [ -f "$file" ]; then
              basename=$(basename "$file" .org)
              pandoc -f org -t html5 -s --css=../../style.css --toc "$file" -o "bytehot/docs/flows/${basename}.html" || echo "Failed to convert $file"
            fi
          done

      - name: Create site README
        run: |
          cat > bytehot/README.md << 'EOF'
# ByteHot Documentation Site

This is the GitHub Pages documentation site for ByteHot - the revolutionary JVM agent for runtime bytecode hot-swapping.

## ğŸ—ï¸ Site Structure

```
gh-pages/
â”œâ”€â”€ index.html              # Main documentation hub (converted from story.org)
â”œâ”€â”€ journal.html             # Development journal (converted from journal.org)  
â”œâ”€â”€ style.css               # Site styling
â”œâ”€â”€ javadocs/               # Generated Javadoc API documentation
â”‚   â”œâ”€â”€ index.html
â”‚   â””â”€â”€ org/acmsl/bytehot/...
â”œâ”€â”€ docs/                   # Architecture and implementation documentation
â”‚   â”œâ”€â”€ configuration.html  # Configuration guide
â”‚   â”œâ”€â”€ User.html           # User aggregate documentation
â”‚   â””â”€â”€ flows/              # Flow documentation
â”‚       â””â”€â”€ user-management-flow.html
â””â”€â”€ README.md               # This file
```

## ğŸ“š Documentation Overview

### ğŸ  [Home - ByteHot Story](index.html)
The complete vision and narrative of ByteHot, including architecture overview and development philosophy.

### ğŸ“– [API Documentation](javadocs/index.html)  
Complete Javadoc API reference generated from source code comments.

### ğŸ“ [Development Journal](journal.html)
Detailed development history, technical decisions, and implementation notes.

### âš™ï¸ [Configuration Guide](docs/configuration.html)
Comprehensive configuration reference with examples for development and production environments.

## ğŸš€ Current Status

**Implementation Status:** Milestone 6C completed with 159/160 tests passing (99.4% success rate)

This documentation site is automatically generated and updated via GitHub Actions.

---

*Generated automatically from the ByteHot project documentation.*
EOF

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './bytehot'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build-docs
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4